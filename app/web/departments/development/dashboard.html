<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bhoomi TechZone - Dashboard</title>
    <style>
        /* CSS Reset and Global Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        
        :root {
            --primary: #2563eb;
            --primary-dark: #1d4ed8;
            --primary-light: #3b82f6;
            --secondary: #10b981;
            --danger: #ef4444;
            --success: #10b981;
            --warning: #f59e0b;
            --info: #3b82f6;
            
            --bg-light: #f9fafb;
            --bg-dark: #111827;
            --bg-card: #ffffff;
            
            --text-primary: #111827;
            --text-secondary: #6b7280;
            --text-light: #f9fafb;
            --text-muted: #9ca3af;
            
            --border-color: #e5e7eb;
            --border-radius: 0.5rem;
        }
        
        body {
            background-color: var(--bg-light);
            color: var(--text-primary);
            line-height: 1.5;
            min-height: 100vh;
        }
        
        /* Layout Styles */
        .dashboard-container {
            display: flex;
            min-height: 100vh;
        }
        
        .sidebar {
            width: 250px;
            background-color: white;
            border-right: 1px solid var(--border-color);
            position: fixed;
            height: 100vh;
            z-index: 100;
            transition: all 0.3s ease;
        }
        
        .main-content {
            flex: 1;
            margin-left: 250px;
            transition: all 0.3s ease;
        }
        
        /* Header & Navigation Styles */
        .sidebar-header {
            padding: 1.5rem;
            display: flex;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
        }
        
        .company-logo {
            display: flex;
            align-items: center;
        }
        
        .company-name {
            font-weight: 600;
            font-size: 1.25rem;
            margin-left: 0.75rem;
        }
        
        .nav-list {
            list-style: none;
            padding: 1rem 0;
        }
        
        .nav-item {
            padding: 0.25rem 1.5rem;
        }
        
        .nav-link {
            display: flex;
            align-items: center;
            padding: 0.75rem 1rem;
            border-radius: var(--border-radius);
            color: var(--text-secondary);
            text-decoration: none;
            transition: all 0.2s ease;
        }
        
        .nav-link:hover {
            background-color: var(--bg-light);
        }
        
        .nav-link.active {
            background-color: rgba(37, 99, 235, 0.1);
            color: var(--primary);
            font-weight: 500;
        }
        
        .nav-link i {
            margin-right: 0.75rem;
            width: 20px;
            text-align: center;
        }
        
        .sidebar-footer {
            position: absolute;
            bottom: 0;
            width: 100%;
            padding: 1rem 1.5rem;
            border-top: 1px solid var(--border-color);
        }
        
        .top-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 2rem;
            background-color: white;
            border-bottom: 1px solid var(--border-color);
        }
        
        .menu-toggle {
            background: none;
            border: none;
            cursor: pointer;
            display: none;
        }
        
        .user-menu {
            display: flex;
            align-items: center;
            position: relative;
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 500;
            margin-right: 0.5rem;
        }
        
        .user-info-header {
            display: flex;
            flex-direction: column;
            margin-right: 0.5rem;
        }
        
        .user-fullname {
            font-weight: 500;
            font-size: 0.9rem;
        }
        
        .user-time {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }
        
        .user-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 0.5rem;
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            width: 200px;
            z-index: 100;
            display: none;
        }
        
        .user-dropdown.active {
            display: block;
        }
        
        .dropdown-item {
            padding: 0.75rem 1rem;
            color: var(--text-secondary);
            text-decoration: none;
            display: flex;
            align-items: center;
        }
        
        .dropdown-item:hover {
            background-color: var(--bg-light);
        }
        
        .dropdown-divider {
            height: 1px;
            background-color: var(--border-color);
            margin: 0.5rem 0;
        }
        
        .page-title {
            font-size: 1.25rem;
            font-weight: 600;
        }

        /* Dashboard Styles */
        .dashboard-main {
            padding: 2rem;
        }
        
        .dashboard-welcome {
            margin-bottom: 2rem;
        }
        
        .welcome-title {
            font-size: 1.75rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        
        .welcome-subtitle {
            color: var(--text-secondary);
            margin-bottom: 1rem;
        }
        
        .status-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 500;
            margin-right: 0.75rem;
        }
        
        .status-online {
            background-color: rgba(16, 185, 129, 0.1);
            color: var(--success);
        }
        
        .quick-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            background-color: white;
            border-radius: var(--border-radius);
            padding: 1.5rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }
        
        .stat-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }
        
        .stat-title {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }
        
        .stat-value {
            font-size: 1.75rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        
        .stat-change {
            font-size: 0.875rem;
        }
        
        .stat-change.positive {
            color: var(--success);
        }
        
        .stat-change.negative {
            color: var(--danger);
        }
        
        .stat-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
        }
        
        .stat-icon.blue {
            background-color: rgba(59, 130, 246, 0.1);
            color: var(--primary);
        }
        
        .stat-icon.green {
            background-color: rgba(16, 185, 129, 0.1);
            color: var(--success);
        }
        
        .stat-icon.yellow {
            background-color: rgba(245, 158, 11, 0.1);
            color: var(--warning);
        }
        
        .stat-icon.red {
            background-color: rgba(239, 68, 68, 0.1);
            color: var(--danger);
        }
        
        .stat-icon.purple {
            background-color: rgba(139, 92, 246, 0.1);
            color: #8b5cf6;
        }
        
        .dashboard-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 1.5rem;
        }
        
        @media (max-width: 1200px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
        }
        
        .card {
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            overflow: hidden;
            margin-bottom: 1.5rem;
        }
        
        .card-header {
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .card-title {
            font-size: 1.125rem;
            font-weight: 600;
        }
        
        .card-action {
            color: var(--primary);
            font-size: 0.875rem;
            font-weight: 500;
            text-decoration: none;
        }
        
        .card-body {
            padding: 1.5rem;
        }
        
        .attendance-actions {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.625rem 1.25rem;
            border-radius: 0.375rem;
            font-weight: 500;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
        }
        
        .btn-primary {
            background-color: var(--primary);
            color: white;
        }
        
        .btn-primary:hover {
            background-color: var(--primary-dark);
        }
        
        .btn-danger {
            background-color: var(--danger);
            color: white;
        }
        
        .btn-danger:hover {
            background-color: #dc2626;
        }
        
        .btn-disabled {
            opacity: 0.5;
            cursor: not-allowed;
            pointer-events: none;
        }
        
        .btn i {
            margin-right: 0.5rem;
        }
        
        .list-item {
            display: flex;
            align-items: center;
            padding: 1rem 0;
            border-bottom: 1px solid var(--border-color);
        }
        
        .list-item:last-child {
            border-bottom: none;
        }
        
        .list-item-icon {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 0.75rem;
            flex-shrink: 0;
        }
        
        .list-item-content {
            flex: 1;
        }
        
        .list-item-title {
            font-weight: 500;
            margin-bottom: 0.25rem;
        }
        
        .list-item-subtitle {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }
        
        .list-item-action {
            margin-left: 0.75rem;
        }
        
        .badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        
        .badge-pending {
            background-color: rgba(245, 158, 11, 0.1);
            color: var(--warning);
        }
        
        .badge-approved {
            background-color: rgba(16, 185, 129, 0.1);
            color: var(--success);
        }
        
        .badge-rejected {
            background-color: rgba(239, 68, 68, 0.1);
            color: var(--danger);
        }
        
        .badge-low {
            background-color: rgba(16, 185, 129, 0.1);
            color: var(--success);
        }
        
        .badge-medium {
            background-color: rgba(245, 158, 11, 0.1);
            color: var(--warning);
        }
        
        .badge-high {
            background-color: rgba(239, 68, 68, 0.1);
            color: var(--danger);
        }
        
        .progress-container {
            background-color: var(--bg-light);
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 0.5rem;
        }
        
        .progress-bar {
            height: 100%;
            border-radius: 4px;
        }
        
        .progress-bar.blue {
            background-color: var(--primary);
        }
        
        .progress-bar.green {
            background-color: var(--success);
        }
        
        .progress-bar.yellow {
            background-color: var(--warning);
        }
        
        .progress-bar.red {
            background-color: var(--danger);
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 255, 255, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(59, 130, 246, 0.2);
            border-radius: 50%;
            border-top-color: var(--primary);
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Toast notification */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 1rem;
            border-radius: var(--border-radius);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            z-index: 9999;
            display: none;
        }
        
        .toast.show {
            display: block;
            animation: toast-in-out 3s forwards;
        }
        
        @keyframes toast-in-out {
            0% { transform: translateY(100%); opacity: 0; }
            15% { transform: translateY(0); opacity: 1; }
            85% { transform: translateY(0); opacity: 1; }
            100% { transform: translateY(100%); opacity: 0; }
        }
        
        /* Role specific dashboard visibility */
        .dashboard-view {
            display: none;
        }
        
        .dashboard-view.active {
            display: block;
        }
        
        /* Message for empty states */
        .empty-state {
            text-align: center;
            padding: 2rem 1rem;
            color: var(--text-secondary);
        }
        
        /* Responsive styles */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }
            
            .main-content {
                margin-left: 0;
            }
            
            .menu-toggle {
                display: block;
            }
            
            .sidebar.active {
                transform: translateX(0);
            }
            
            .quick-stats {
                grid-template-columns: 1fr;
            }
            
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
        }
        
        /* Processing state for attendance buttons to prevent double-clicks */
        .btn.processing {
            opacity: 0.6;
            cursor: not-allowed;
            pointer-events: none;
        }
        
        .btn.processing::after {
            content: " ⏳";
        }
    </style>
</head>
<body>
    <div id="loadingOverlay" class="loading-overlay">
        <div class="spinner"></div>
    </div>

    <div class="dashboard-container">
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="company-logo">
                    <svg width="32" height="32" viewBox="0 0 32 32" fill="none">
                        <path d="M16 4L28 16L16 28L4 16L16 4Z" fill="#2563eb" />
                        <path d="M16 10L22 16L16 22L10 16L16 10Z" fill="#1d4ed8" />
                    </svg>
                    <div class="company-name">Bhoomi TechZone</div>
                </div>
            </div>
            
            <nav class="sidebar-nav">
                <ul id="navigationMenu" class="nav-list">
                    <!-- Dynamic navigation will be populated here -->
                </ul>
            </nav>
            
        </aside>
        
        <div class="main-content">
            <header class="top-header">
                <div class="left-section">
                    <button class="menu-toggle" id="menuToggle">
                        <span>☰</span>
                    </button>
                    <h1 class="page-title">Dashboard</h1>
                </div>
                
                <div class="user-menu" id="userMenu">
                    <div class="user-avatar" id="userInitials">U</div>
                    <div class="user-info-header">
                        <div id="userFullName" class="user-fullname">User Name</div>
                        <div id="userTimeDisplay" class="user-time"></div>
                    </div>
                    
                    <div class="user-dropdown" id="userDropdown">
                        <a href="/app/it/profile" class="dropdown-item">
                            <i>👤</i> Your Profile
                        </a>
                        
                        <div class="dropdown-divider"></div>
                        <a href="#" class="dropdown-item" id="logoutBtn">
                            <i>🚪</i> Log Out
                        </a>
                    </div>
                </div>
            </header>
            
            <main class="dashboard-main">
                <!-- Employee Dashboard View -->
                <div class="dashboard-view" id="employeeDashboard">
                    <div class="dashboard-welcome">
                        <h1 class="welcome-title">Welcome back, <span id="employeeName"></span>!</h1>
                        <p class="welcome-subtitle" id="dateDisplay">Here's your activity summary for today, Friday, 13 June 2025</p>
                        <div>
                            <span class="status-badge status-online">🟢 Online</span>
                            <span>Current time: <strong id="timeDisplay"></strong></span>
                        </div>
                    </div>
                    
                    <div class="quick-stats" id="employeeStats">
                        <!-- Stats will be loaded dynamically -->
                    </div>
                    
                    <div class="dashboard-grid">
                        <div>
                            <div class="card">
                                <div class="card-header">
                                    <h2 class="card-title">Today's Attendance</h2>
                                </div>
                                <div class="card-body" id="todayAttendance">
                                    <!-- Attendance details will be loaded from API -->
                                    <div class="empty-state">
                                        <p>Loading attendance...</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="card">
                                <div class="card-header">
                                    <h2 class="card-title">Upcoming Tasks</h2>
                                    <a href="/app/it/projects" class="card-action">View All</a>
                                </div>
                                <div class="card-body" id="upcomingTasks">
                                    <!-- Tasks will be loaded from API -->
                                    <div class="empty-state">
                                        <p>Loading tasks...</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="card">
                                <div class="card-header">
                                    <h2 class="card-title">Performance Overview</h2>
                                </div>
                                <div class="card-body" id="performanceOverview">
                                    <!-- Performance data will be loaded from API -->
                                    <div class="empty-state">
                                        <p>Loading performance data...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div>
                            <div class="card">
                                <div class="card-header">
                                    <h2 class="card-title">Daily Report</h2>
                                    <a href="/app/it/daily-reports" class="card-action">View All</a>
                                </div>
                                <div class="card-body" id="dailyReports">
                                    <!-- Daily reports will be loaded from API -->
                                    <div class="empty-state">
                                        <p>Loading daily reports...</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="card">
                                <div class="card-header">
                                    <h2 class="card-title">Leave Requests</h2>
                                    <a href="/app/it/leave-requests" class="card-action">View All</a>
                                </div>
                                <div class="card-body" id="leaveRequests">
                                    <!-- Leave requests will be loaded from API -->
                                    <div class="empty-state">
                                        <p>Loading leave requests...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Team Lead Dashboard View -->
                <div class="dashboard-view" id="teamLeadDashboard">
                    <div class="dashboard-welcome">
                        <h1 class="welcome-title">Team Lead Dashboard</h1>
                        <p class="welcome-subtitle" id="tlDateDisplay">Team overview for Friday, 13 June 2025</p>
                        <div>
                            <span class="status-badge status-online">🟢 Online</span>
                            <span>Current time: <strong id="tlTimeDisplay"></strong></span>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">Today's Attendance</h2>
                        </div>
                        <div class="card-body" id="teamLeadAttendance">
                            <!-- Team Lead's attendance will be loaded from API -->
                            <div class="empty-state">
                                <p>Loading attendance...</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="dashboard-grid">
                        <div>
                            <div class="card">
                                <div class="card-header">
                                    <h2 class="card-title">Active Projects</h2>
                                    <a href="/app/it/projects" class="card-action">View All</a>
                                </div>
                                <div class="card-body" id="activeProjects">
                                    <!-- Projects will be loaded from API -->
                                    <div class="empty-state">
                                        <p>Loading projects...</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="card">
                                <div class="card-header">
                                    <h2 class="card-title">Team Members</h2>
                                </div>
                                <div class="card-body" id="teamMembers">
                                    <!-- Team members will be loaded from API -->
                                    <div class="empty-state">
                                        <p>Loading team members...</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="card">
                                <div class="card-header">
                                    <h2 class="card-title">Daily Report</h2>
                                    <a href="/app/it/daily-reports" class="card-action">Create/View</a>
                                </div>
                                <div class="card-body" id="teamLeadDailyReport">
                                    <!-- Daily report will be loaded from API -->
                                    <div class="empty-state">
                                        <p>Loading daily report...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div>
                            <div class="card">
                                <div class="card-header">
                                    <h2 class="card-title">Pending Approvals</h2>
                                </div>
                                <div class="card-body" id="pendingApprovals">
                                    <!-- Pending approvals will be loaded from API -->
                                    <div class="empty-state">
                                        <p>Loading pending approvals...</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="card">
                                <div class="card-header">
                                    <h2 class="card-title">Team Attendance</h2>
                                </div>
                                <div class="card-body" id="teamAttendance">
                                    <!-- Team attendance will be loaded from API -->
                                    <div class="empty-state">
                                        <p>Loading team attendance...</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="card">
                                <div class="card-header">
                                    <h2 class="card-title">Team Reports</h2>
                                </div>
                                <div class="card-body" id="teamReports">
                                    <!-- Team reports will be loaded from API -->
                                    <div class="empty-state">
                                        <p>Loading team reports...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Manager Dashboard View -->
                <div class="dashboard-view" id="managerDashboard">
                    <div class="dashboard-welcome">
                        <h1 class="welcome-title">Manager Dashboard</h1>
                        <p class="welcome-subtitle" id="mgrDateDisplay">Department overview for Friday, 13 June 2025</p>
                        <div>
                            <span class="status-badge status-online">🟢 Online</span>
                            <span>Current time: <strong id="mgrTimeDisplay"></strong></span>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">Today's Attendance</h2>
                        </div>
                        <div class="card-body" id="managerAttendance">
                            <!-- Manager's attendance will be loaded from API -->
                            <div class="empty-state">
                                <p>Loading attendance...</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="dashboard-grid">
                        <div>
                            <div class="card">
                                <div class="card-header">
                                    <h2 class="card-title">Department Projects</h2>
                                    <a href="/app/it/projects" class="card-action">View All</a>
                                </div>
                                <div class="card-body" id="departmentProjects">
                                    <!-- Department projects will be loaded from API -->
                                    <div class="empty-state">
                                        <p>Loading department projects...</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="card">
                                <div class="card-header">
                                    <h2 class="card-title">Team Leaders</h2>
                                </div>
                                <div class="card-body" id="teamLeaders">
                                    <!-- Team leaders will be loaded from API -->
                                    <div class="empty-state">
                                        <p>Loading team leaders...</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="card">
                                <div class="card-header">
                                    <h2 class="card-title">Daily Report</h2>
                                    <a href="/app/it/daily-reports" class="card-action">Create/View</a>
                                </div>
                                <div class="card-body" id="managerDailyReport">
                                    <!-- Daily report will be loaded from API -->
                                    <div class="empty-state">
                                        <p>Loading daily report...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div>
                            <div class="card">
                                <div class="card-header">
                                    <h2 class="card-title">Pending Approvals</h2>
                                </div>
                                <div class="card-body" id="managerApprovals">
                                    <!-- Manager approvals will be loaded from API -->
                                    <div class="empty-state">
                                        <p>Loading pending approvals...</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="card">
                                <div class="card-header">
                                    <h2 class="card-title">Department Overview</h2>
                                </div>
                                <div class="card-body" id="departmentOverview">
                                    <!-- Department overview will be loaded from API -->
                                    <div class="empty-state">
                                        <p>Loading department overview...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Director Dashboard View -->
                <div class="dashboard-view" id="directorDashboard">
                    <div class="dashboard-welcome">
                        <h1 class="welcome-title">Executive Dashboard</h1>
                        <p class="welcome-subtitle" id="dirDateDisplay">Company-wide overview for Friday, 13 June 2025</p>
                        <div>
                            <span class="status-badge status-online">🟢 Online</span>
                            <span>Current time: <strong id="dirTimeDisplay"></strong></span>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">Today's Attendance</h2>
                        </div>
                        <div class="card-body" id="directorAttendance">
                            <!-- Director's attendance will be loaded from API -->
                            <div class="empty-state">
                                <p>Loading attendance...</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="dashboard-grid">
                        <div>
                            <div class="card">
                                <div class="card-header">
                                    <h2 class="card-title">All Projects Status</h2>
                                    <a href="/app/it/projects" class="card-action">View All</a>
                                </div>
                                <div class="card-body" id="allProjects">
                                    <!-- All projects will be loaded from API -->
                                    <div class="empty-state">
                                        <p>Loading projects data...</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="card">
                                <div class="card-header">
                                    <h2 class="card-title">Department Performance</h2>
                                </div>
                                <div class="card-body" id="allDepartments">
                                    <!-- Departments will be loaded from API -->
                                    <div class="empty-state">
                                        <p>Loading departments data...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div>
                            <div class="card">
                                <div class="card-header">
                                    <h2 class="card-title">Managers Overview</h2>
                                </div>
                                <div class="card-body" id="allManagers">
                                    <!-- Managers will be loaded from API -->
                                    <div class="empty-state">
                                        <p>Loading managers data...</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="card">
                                <div class="card-header">
                                    <h2 class="card-title">Company Metrics</h2>
                                </div>
                                <div class="card-body" id="companyMetrics">
                                    <!-- Company metrics will be loaded from API -->
                                    <div class="empty-state">
                                        <p>Loading company metrics...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>
    
    <!-- Toast notification -->
    <div id="toast" class="toast"></div>
    
    <script>
        // IST timezone conversion (UTC +5:30)
        function getCurrentTimeFormatted() {
            const now = new Date();
            return now.toLocaleTimeString('en-IN', {
                timeZone: 'Asia/Kolkata',
                hour12: false,
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // Format user display name
        function formatUserDisplayName(user) {
            if (user.first_name && user.last_name) {
                return `${user.first_name} ${user.last_name}`;
            }
            return user.full_name || user.username || 'User';
        }

        // Update user display elements
        function updateUserDisplay(user) {
            const displayName = formatUserDisplayName(user);
            const currentTime = getCurrentTimeFormatted();
            
            // Update sidebar
            const sidebarUsername = document.getElementById('sidebar-username');
            const sidebarPosition = document.getElementById('sidebar-position');
            if (sidebarUsername) sidebarUsername.textContent = displayName;
            if (sidebarPosition) sidebarPosition.textContent = user.position || user.role || 'Team Member';
            
            // Update navbar time display
            const userTimeDisplay = document.getElementById('userTimeDisplay');
            if (userTimeDisplay) userTimeDisplay.textContent = `${currentTime} - ${displayName}`;
            
            // Update header user info
            const userFullName = document.getElementById('userFullName');
            const userInitials = document.getElementById('userInitials');
            if (userFullName) userFullName.textContent = displayName;
            if (userInitials) {
                const initial = user.first_name && user.last_name ? 
                              (user.first_name[0] + user.last_name[0]).toUpperCase() :
                              displayName.charAt(0).toUpperCase();
                userInitials.textContent = initial;
            }
            
            // Update welcome message
            const employeeName = document.getElementById('employeeName');
            if (employeeName) employeeName.textContent = displayName;
        }

        // Start live time updates
        function startLiveTimeUpdates(user) {
            updateUserDisplay(user); // Initial update
            setInterval(() => {
                const displayName = formatUserDisplayName(user);
                const currentTime = getCurrentTimeFormatted();
                const userTimeDisplay = document.getElementById('userTimeDisplay');
                if (userTimeDisplay) userTimeDisplay.textContent = `${currentTime} - ${displayName}`;
            }, 1000);
        }

        // Navigation configuration for different roles
        const navigationConfig = {
            // IT Department Developer/Interns/Executives - Basic menu
            intern: [
                { icon: '📊', label: 'Dashboard', href: '/app/it/dashboard', active: true },
                { icon: '🕒', label: 'Attendance', href: '/app/it/attendance' },
                { icon: '📁', label: 'Projects', href: '/app/it/projects' },
                { icon: '📝', label: 'Daily Reports', href: '/app/it/daily-reports' },
                { icon: '⭐', label: 'Performance', href: '/app/it/performance' },
                { icon: '📅', label: 'Leave Requests', href: '/app/it/leave-requests' },
                { icon: '👤', label: 'Profile', href: '/app/it/profile' }
            ],
            developer: [
                { icon: '📊', label: 'Dashboard', href: '/app/it/dashboard', active: true },
                { icon: '🕒', label: 'Attendance', href: '/app/it/attendance' },
                { icon: '📁', label: 'Projects', href: '/app/it/projects' },
                { icon: '📝', label: 'Daily Reports', href: '/app/it/daily-reports' },
                { icon: '⭐', label: 'Performance', href: '/app/it/performance' },
                { icon: '📅', label: 'Leave Requests', href: '/app/it/leave-requests' },
                { icon: '👤', label: 'Profile', href: '/app/it/profile' }
            ],
            executive: [
                { icon: '📊', label: 'Dashboard', href: '/app/it/dashboard', active: true },
                { icon: '🕒', label: 'Attendance', href: '/app/it/attendance' },
                { icon: '📁', label: 'Projects', href: '/app/it/projects' },
                { icon: '📝', label: 'Daily Reports', href: '/app/it/daily-reports' },
                { icon: '⭐', label: 'Performance', href: '/app/it/performance' },
                { icon: '📅', label: 'Leave Requests', href: '/app/it/leave-requests' },
                { icon: '👤', label: 'Profile', href: '/app/it/profile' }
            ],
            // IT Department Team Leader - With Team management access
            team_lead: [
                { icon: '📊', label: 'Dashboard', href: '/app/it/dashboard', active: true },
                { icon: '🕒', label: 'Attendance', href: '/app/it/attendance' },
                { icon: '📁', label: 'Projects', href: '/app/it/projects' },
                { icon: '📝', label: 'Daily Reports', href: '/app/it/daily-reports' },
                { icon: '👥', label: 'Team', href: '/app/it/team' },
                { icon: '⭐', label: 'Performance', href: '/app/it/performance' },
                { icon: '📅', label: 'Leave Requests', href: '/app/it/leave-requests' },
                { icon: '👤', label: 'Profile', href: '/app/it/profile' }
            ],
            // IT Department Manager - Full access including Team management
            manager: [
                { icon: '📊', label: 'Dashboard', href: '/app/it/dashboard', active: true },
                { icon: '🕒', label: 'Attendance', href: '/app/it/attendance' },
                { icon: '📁', label: 'Projects', href: '/app/it/projects' },
                { icon: '📝', label: 'Daily Reports', href: '/app/it/daily-reports' },
                { icon: '👥', label: 'Team', href: '/app/it/team' },
                { icon: '⭐', label: 'Performance', href: '/app/it/performance' },
                { icon: '📅', label: 'Leave Requests', href: '/app/it/leave-requests' },
                { icon: '👤', label: 'Profile', href: '/app/it/profile' }
            ],
            dev_manager: [
                { icon: '📊', label: 'Dashboard', href: '/app/it/dashboard', active: true },
                { icon: '🕒', label: 'Attendance', href: '/app/it/attendance' },
                { icon: '📁', label: 'Projects', href: '/app/it/projects' },
                { icon: '📝', label: 'Daily Reports', href: '/app/it/daily-reports' },
                { icon: '👥', label: 'Team', href: '/app/it/team' },
                { icon: '⭐', label: 'Performance', href: '/app/it/performance' },
                { icon: '📅', label: 'Leave Requests', href: '/app/it/leave-requests' },
                { icon: '👤', label: 'Profile', href: '/app/it/profile' }
            ],
            // Fallback for backward compatibility
            employee: [
                { icon: '📊', label: 'Dashboard', href: '/app/it/dashboard', active: true },
                { icon: '🕒', label: 'Attendance', href: '/app/it/attendance' },
                { icon: '📁', label: 'Projects', href: '/app/it/projects' },
                { icon: '📝', label: 'Daily Reports', href: '/app/it/daily-reports' },
                { icon: '⭐', label: 'Performance', href: '/app/it/performance' },
                { icon: '📅', label: 'Leave Requests', href: '/app/it/leave-requests' },
                { icon: '👤', label: 'Profile', href: '/app/it/profile' }
            ]
        };

        // Generate navigation menu based on user role
        function generateNavigationMenu(userRole) {
            const menuItems = navigationConfig[userRole] || navigationConfig.employee;
            const navigationMenu = document.getElementById('navigationMenu');
            
            if (!navigationMenu) return;
            
            navigationMenu.innerHTML = '';
            
            menuItems.forEach(item => {
                const li = document.createElement('li');
                li.className = 'nav-item';
                
                const a = document.createElement('a');
                a.href = item.href;
                a.className = item.active ? 'nav-link active' : 'nav-link';
                a.innerHTML = `<i>${item.icon}</i>${item.label}`;
                
                li.appendChild(a);
                navigationMenu.appendChild(li);
            });
        }

        // Setup role-based UI elements
        function setupRoleBasedUI(user) {
            const userRole = user.role || 'employee';
            generateNavigationMenu(userRole);
            
            // Log user role for debugging
            console.log('User role detected:', userRole);
        }

        // Get current user from API or localStorage
        async function getCurrentUser() {
            try {
                const token = localStorage.getItem('bhoomitechzone_token');
                if (!token) return null;
                
                const response = await fetch('/users/me', {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    return await response.json();
                }
            } catch (error) {
                console.error('Error fetching current user:', error);
            }
            
            // Fallback to mock user if API fails
            return {
                id: 1,
                username: 'user',
                first_name: 'User',
                last_name: 'Name',
                role: 'employee',
                position: 'Developer'
            };
        }

        document.addEventListener('DOMContentLoaded', async function() {
            // Initialize with the current timestamp dynamically
            const currentTimestamp = getCurrentTimeFormatted();
            const currentDate = new Date();
            
            // Update all date/time displays with the current timestamp
            updateDateTimeDisplays(currentDate);
            
            try {
                // Check auth token
                const token = localStorage.getItem('bhoomitechzone_token');
                if (!token) {
                    window.location.href = '/app/login';
                    return;
                }
                
                // Get current user and setup UI
                const currentUser = await getCurrentUser();
                
                // Update UI with user info
                if (currentUser) {
                    updateUserDisplay(currentUser);
                    
                    // Setup role-based UI
                    setupRoleBasedUI(currentUser);
                    
                    // Start live clock update
                    startLiveTimeUpdates(currentUser);
                }
                
                // Load user data
                await loadUserData();
                
                // Setup global event delegation for attendance buttons to prevent double-click issues
                document.addEventListener('click', function(e) {
                    // Check if clicked element is a check-in button
                    if (e.target.id && e.target.id.includes('CheckInBtn')) {
                        e.preventDefault();
                        e.stopPropagation();
                        
                        // Prevent double clicks
                        if (e.target.disabled || e.target.classList.contains('processing')) {
                            return;
                        }
                        
                        // Add processing class to prevent multiple clicks
                        e.target.classList.add('processing');
                        e.target.disabled = true;
                        e.target.textContent = 'Checking in...';
                        
                        handleCheckIn().then(() => {
                            console.log('Check-in completed successfully');
                            // The displayAttendance function will handle UI updates
                            // Don't restore button state here as it will be replaced by new UI
                        }).catch((error) => {
                            console.error('Check-in failed:', error);
                            // Restore button state on error
                            e.target.classList.remove('processing');
                            e.target.disabled = false;
                            e.target.innerHTML = '<i>➡️</i> Check In';
                        });
                    }
                    
                    // Check if clicked element is a check-out button
                    if (e.target.id && e.target.id.includes('CheckOutBtn')) {
                        e.preventDefault();
                        e.stopPropagation();
                        
                        // Prevent double clicks
                        if (e.target.disabled || e.target.classList.contains('processing')) {
                            return;
                        }
                        
                        // Add processing class to prevent multiple clicks
                        e.target.classList.add('processing');
                        e.target.disabled = true;
                        e.target.textContent = 'Checking out...';
                        
                        handleCheckOut().then(() => {
                            console.log('Check-out completed successfully');
                            // The displayAttendance function will handle UI updates
                            // Don't restore button state here as it will be replaced by new UI
                        }).catch((error) => {
                            console.error('Check-out failed:', error);
                            // Restore button state on error
                            e.target.classList.remove('processing');
                            e.target.disabled = false;
                            e.target.innerHTML = '<i>⬅️</i> Check Out';
                        });
                    }
                });
                
                // Add event listeners
                setupEventListeners();
                
                // Hide loading overlay
                document.getElementById('loadingOverlay').style.display = 'none';
            } catch (error) {
                console.error('Error initializing dashboard:', error);
                showToast('Error loading dashboard data');
                document.getElementById('loadingOverlay').style.display = 'none';
            }
        });
        
        function updateDateTimeDisplays(date) {
            // Format the date as a string like "Friday, 13 June 2025"
            const dateString = date.toLocaleDateString('en-US', {
                weekday: 'long',
                day: 'numeric',
                month: 'long',
                year: 'numeric'
            });
            
            // Format the time as a string like "20:30"
            const timeString = date.toLocaleTimeString('en-US', {
                hour: '2-digit',
                minute: '2-digit',
                hour12: false
            });
            
            // Update all date displays
            document.getElementById('dateDisplay').textContent = `Here's your activity summary for today, ${dateString}`;
            document.getElementById('tlDateDisplay').textContent = `Team overview for ${dateString}`;
            document.getElementById('mgrDateDisplay').textContent = `Department overview for ${dateString}`;
            document.getElementById('dirDateDisplay').textContent = `Company-wide overview for ${dateString}`;
            
            // Update all time displays
            document.getElementById('timeDisplay').textContent = timeString;
            document.getElementById('tlTimeDisplay').textContent = timeString;
            document.getElementById('mgrTimeDisplay').textContent = timeString;
            document.getElementById('dirTimeDisplay').textContent = timeString;
        }
        
        async function loadUserData() {
            try {
                const token = localStorage.getItem('bhoomitechzone_token');
                
                // Fetch current user data
                const response = await fetch('/users/me', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (!response.ok) {
                    if (response.status === 401) {
                        localStorage.removeItem('bhoomitechzone_token');
                        window.location.href = '/app/login';
                        return;
                    }
                    throw new Error('Failed to fetch user data');
                }
                
                const userData = await response.json();
                
                // Store user data
                window.currentUser = userData;
                window.userRole = userData.role;
                const username = userData.username || 'user'; // Default to 'user' if username not available
                
                // Update UI with user info
                // Update UI elements safely
                const userInitials = document.getElementById('userInitials');
                const userTimeDisplay = document.getElementById('userTimeDisplay');
                const sidebarUsername = document.getElementById('sidebar-username');
                const sidebarPosition = document.getElementById('sidebar-position');
                const employeeName = document.getElementById('employeeName');
                
                const displayName = formatUserDisplayName(userData);
                const initials = getInitials(userData.first_name, userData.last_name);
                
                if (userInitials) userInitials.textContent = initials;
                if (userTimeDisplay) userTimeDisplay.textContent = `${getCurrentTimeFormatted()} - ${displayName}`;
                if (sidebarUsername) sidebarUsername.textContent = displayName;
                if (sidebarPosition) sidebarPosition.textContent = userData.position || userData.role || 'Employee';
                if (employeeName) employeeName.textContent = displayName;
                
                // Set up dashboard based on role
                showDashboardByRole(userData.role);
                updateSidebarMenu(userData.role);
                
                // Load role-specific data
                await loadDashboardData(userData.role);
                
                return userData;
            } catch (error) {
                console.error('Error loading user data:', error);
                
                // Set default values as fallback with null checks
                const userInitials = document.getElementById('userInitials');
                const userTimeDisplay = document.getElementById('userTimeDisplay');
                const sidebarUsername = document.getElementById('sidebar-username');
                const sidebarPosition = document.getElementById('sidebar-position');
                const employeeName = document.getElementById('employeeName');
                
                if (userInitials) userInitials.textContent = 'U';
                if (userTimeDisplay) userTimeDisplay.textContent = `${getCurrentTimeFormatted()} - User`;
                if (sidebarUsername) sidebarUsername.textContent = 'User';
                if (sidebarPosition) sidebarPosition.textContent = 'Employee';
                if (employeeName) employeeName.textContent = 'User';
                
                showToast('Failed to load user data');
                
                // Try to load the dashboard anyway as a fallback
                showDashboardByRole('employee');
                await loadEmployeeDashboard();
                
                return null;
            }
        }
        
        function showDashboardByRole(role) {
            // Hide all dashboard views
            document.querySelectorAll('.dashboard-view').forEach(view => {
                view.classList.remove('active');
            });
            
            // Show the appropriate dashboard based on role
            if (role === 'hr' || role === 'HR') {
                document.getElementById('managerDashboard').classList.add('active');
            } else if (role === 'team_lead') {
                document.getElementById('teamLeadDashboard').classList.add('active');
            } else if (role === 'manager' || role === 'dev_manager') {
                document.getElementById('managerDashboard').classList.add('active');
            } else if (role === 'director' || role === 'admin') {
                document.getElementById('directorDashboard').classList.add('active');
            } else {
                // Default to employee dashboard
                document.getElementById('employeeDashboard').classList.add('active');
            }
        }
        
        function updateSidebarMenu(role) {
            // Show/hide menu items based on role
            const isManager = ['manager', 'team_lead'].includes(role);
            const isHR = ['hr', 'HR'].includes(role);
            const isDirector = ['director', 'admin'].includes(role);
            
            // Show/hide manager-specific items
            document.querySelectorAll('.manager-nav').forEach(item => {
                item.style.display = isManager || isDirector ? 'list-item' : 'none';
            });
            
            // Show/hide HR-specific items
            document.querySelectorAll('.hr-nav').forEach(item => {
                item.style.display = isHR || isDirector ? 'list-item' : 'none';
            });
            
            // Show/hide director-specific items
            document.querySelectorAll('.director-nav').forEach(item => {
                item.style.display = isDirector ? 'list-item' : 'none';
            });
        }
        
        async function loadDashboardData(role) {
            if (role === 'hr' || role === 'HR') {
                await loadHRDashboard();
            } else if (role === 'team_lead') {
                await loadTeamLeadDashboard();
            } else if (role === 'manager' || role === 'dev_manager') {
                await loadManagerDashboard();
            } else if (role === 'director' || role === 'admin') {
                await loadDirectorDashboard();
            } else {
                // Default to employee dashboard
                await loadEmployeeDashboard();
            }
        }
        
        async function loadEmployeeDashboard() {
            const token = localStorage.getItem('bhoomitechzone_token');
            
            // Load today's attendance
            try {
                const todayDate = formatDate(new Date());
                const attendanceResponse = await fetch(`/attendance/history?start_date=${todayDate}&end_date=${todayDate}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (attendanceResponse.ok) {
                    const attendanceData = await attendanceResponse.json();
                    displayAttendance(attendanceData, 'todayAttendance');
                } else {
                    throw new Error('Failed to load attendance data');
                }
            } catch (error) {
                console.error('Error loading attendance:', error);
                document.getElementById('todayAttendance').innerHTML = `
                    <div class="empty-state">
                        <p>No attendance record for today.</p>
                        <button class="btn btn-primary" id="checkInBtn">
                            <i>➡️</i> Check In
                        </button>
                    </div>
                `;
                // Event listeners are now handled by global event delegation
                // No need to add individual listeners here
            }
            
            // Load employee stats directly from the projects/stats/summary endpoint
            try {
                const statsResponse = await fetch('/projects/stats/summary', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (statsResponse.ok) {
                    const statsData = await statsResponse.json();
                    displayEmployeeStats(statsData);
                } else {
                    throw new Error('Failed to load employee stats');
                }
            } catch (error) {
                console.error('Error loading employee stats:', error);
                document.getElementById('employeeStats').innerHTML = `
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <div>
                                <div class="stat-title">Projects</div>
                                <div class="stat-value">0</div>
                                <div class="stat-change">No projects assigned</div>
                            </div>
                            <div class="stat-icon blue">📁</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <div>
                                <div class="stat-title">Tasks</div>
                                <div class="stat-value">0</div>
                                <div class="stat-change">No tasks assigned</div>
                            </div>
                            <div class="stat-icon green">📝</div>
                        </div>
                    </div>
                `;
            }
            
            // Load tasks - this returns projects, which we'll use to extract tasks
            try {
                const projectsResponse = await fetch('/projects', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (projectsResponse.ok) {
                    const projectsData = await projectsResponse.json();
                    displayTasks(projectsData);
                } else {
                    throw new Error('Failed to load projects data');
                }
            } catch (error) {
                console.error('Error loading tasks:', error);
                document.getElementById('upcomingTasks').innerHTML = `
                    <div class="empty-state">
                        <p>No upcoming tasks found.</p>
                    </div>
                `;
            }
            
            // Load performance data
            try {
                const performanceResponse = await fetch('/performance-reviews/stats', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (performanceResponse.ok) {
                    const performanceData = await performanceResponse.json();
                    displayPerformance(performanceData);
                } else {
                    throw new Error('Failed to load performance data');
                }
            } catch (error) {
                console.error('Error loading performance:', error);
                document.getElementById('performanceOverview').innerHTML = `
                    <div class="empty-state">
                        <p>No performance data available.</p>
                    </div>
                `;
            }
            
            // Load leave requests
            try {
                const leaveResponse = await fetch('/leave-requests/', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (leaveResponse.ok) {
                    const leaveData = await leaveResponse.json();
                    displayLeaveRequests(leaveData);
                } else {
                    throw new Error('Failed to load leave data');
                }
            } catch (error) {
                console.error('Error loading leave requests:', error);
                document.getElementById('leaveRequests').innerHTML = `
                    <div class="empty-state">
                        <p>No leave requests found.</p>
                        <button class="btn btn-primary" id="requestLeaveBtn">
                            <i>➕</i> Request Leave
                        </button>
                    </div>
                `;
                document.getElementById('requestLeaveBtn')?.addEventListener('click', () => {
                    window.location.href = '/app/it/leave-requests';
                });
            }
            
            // Load daily reports
            loadDailyReport();
        }
        
        async function loadDailyReport() {
            const token = localStorage.getItem('bhoomitechzone_token');
            try {
                // Direct API call to get daily reports
                const reportsResponse = await fetch('/daily-reports/', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (!reportsResponse.ok) {
                    throw new Error('Failed to fetch daily reports');
                }
                
                const reports = await reportsResponse.json();
                
                // Find today's report if it exists
                const today = formatDate(new Date());
                const todayReport = reports.find(r => r.report_date === today || r.report_date === formatDate(new Date(today).setDate(new Date(today).getDate() + 1)));
                
                if (todayReport) {
                    displayDailyReport(todayReport, 'dailyReports');
                } else {
                    document.getElementById('dailyReports').innerHTML = `
                        <div class="empty-state">
                            <p>No daily report for today.</p>
                            <button class="btn btn-primary" id="createDailyReportBtn">
                                <i>➕</i> Create Today's Report
                            </button>
                        </div>
                    `;
                    document.getElementById('createDailyReportBtn').addEventListener('click', () => {
                        window.location.href = '/app/it/daily-reports?action=create';
                    });
                }
            } catch (error) {
                console.error('Error loading daily report:', error);
                document.getElementById('dailyReports').innerHTML = `
                    <div class="empty-state">
                        <p>Error loading daily report.</p>
                        <button class="btn btn-primary" id="createDailyReportBtn">
                            <i>➕</i> Create Today's Report
                        </button>
                    </div>
                `;
                document.getElementById('createDailyReportBtn').addEventListener('click', () => {
                    window.location.href = '/app/it/daily-reports?action=create';
                });
            }
        }
        
        async function loadTeamLeadDashboard() {
            const token = localStorage.getItem('bhoomitechzone_token');
            
            // Load team lead's attendance first
            try {
                const todayDate = formatDate(new Date());
                const attendanceResponse = await fetch(`/attendance/history?start_date=${todayDate}&end_date=${todayDate}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (attendanceResponse.ok) {
                    const attendanceData = await attendanceResponse.json();
                    displayAttendance(attendanceData, 'teamLeadAttendance');
                } else {
                    throw new Error('Failed to load attendance data');
                }
            } catch (error) {
                console.error('Error loading attendance:', error);
                document.getElementById('teamLeadAttendance').innerHTML = `
                    <div class="empty-state">
                        <p>No attendance record for today.</p>
                        <button class="btn btn-primary" id="tlCheckInBtn">
                            <i>➡️</i> Check In
                        </button>
                    </div>
                `;
                // Event listeners are now handled by global event delegation
                // No need to add individual listeners here
            }
            
            // Load team members from current active projects where user is project manager
            try {
                const teamResponse = await fetch('/api/development/my-project-team-members', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (teamResponse.ok) {
                    const teamData = await teamResponse.json();
                    displayTeamMembers(teamData);
                } else {
                    throw new Error('Failed to load team data');
                }
            } catch (error) {
                console.error('Error loading team members:', error);
                document.getElementById('teamMembers').innerHTML = `
                    <div class="empty-state">
                        <p>No team members assigned to your active projects.</p>
                    </div>
                `;
            }
            
            // Load active projects - include projects where tasks are assigned to team members
            try {
                // First load projects managed by team lead
                const projectsResponse = await fetch('/projects?only_managed=true', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (projectsResponse.ok) {
                    const managedProjects = await projectsResponse.json();
                    
                    // Then load all projects to find those with tasks assigned to team members
                    const allProjectsResponse = await fetch('/projects', {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    
                    if (allProjectsResponse.ok) {
                        const allProjects = await allProjectsResponse.json();
                        
                        // Get team members data to check task assignments
                        const teamResponse = await fetch('/api/development/team-members', {
                            headers: { 'Authorization': `Bearer ${token}` }
                        });
                        
                        if (teamResponse.ok) {
                            const teamData = await teamResponse.json();
                            const teamMemberIds = teamData.map(member => member._id);
                            
                            // Find projects where team members are assigned tasks
                            const projectsWithAssignedTeamTasks = allProjects.filter(project => {
                                if (!managedProjects.some(mp => mp._id === project._id) && 
                                    project.tasks && project.tasks.length > 0) {
                                    return project.tasks.some(task => 
                                        task.assigned_to && teamMemberIds.includes(task.assigned_to)
                                    );
                                }
                                return false;
                            });
                            
                            // Combine both sets of projects and display
                            const combinedProjects = [...managedProjects, ...projectsWithAssignedTeamTasks];
                            displayProjects(combinedProjects, 'activeProjects');
                        } else {
                            displayProjects(managedProjects, 'activeProjects');
                        }
                    } else {
                        displayProjects(managedProjects, 'activeProjects');
                    }
                } else {
                    throw new Error('Failed to load managed projects');
                }
            } catch (error) {
                console.error('Error loading projects:', error);
                document.getElementById('activeProjects').innerHTML = `
                    <div class="empty-state">
                        <p>Error loading active projects.</p>
                    </div>
                `;
            }
            
            // Load team attendance for project team members only
            try {
                // First get project team members
                const teamMembersResponse = await fetch('/api/development/my-project-team-members', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (teamMembersResponse.ok) {
                    const teamMembers = await teamMembersResponse.json();
                    const teamMemberIds = teamMembers.map(member => member.id);
                    
                    if (teamMemberIds.length > 0) {
                        // Get attendance for all users and filter
                        const attendanceResponse = await fetch('/attendance/team', {
                            headers: { 'Authorization': `Bearer ${token}` }
                        });
                        
                        if (attendanceResponse.ok) {
                            const allAttendanceData = await attendanceResponse.json();
                            // Filter to only show attendance for project team members
                            const filteredAttendanceData = allAttendanceData.filter(record => 
                                teamMemberIds.includes(record.user_id)
                            );
                            
                            // Add user names to attendance records
                            const attendanceWithNames = filteredAttendanceData.map(record => {
                                const member = teamMembers.find(m => m.id === record.user_id);
                                return {
                                    ...record,
                                    user_name: member ? member.full_name : `User ${record.user_id?.substring(0, 6)}`
                                };
                            });
                            
                            displayTeamAttendance(attendanceWithNames);
                        } else {
                            throw new Error('Failed to load team attendance');
                        }
                    } else {
                        // No project team members, show empty state
                        document.getElementById('teamAttendance').innerHTML = `
                            <div class="empty-state">
                                <p>No project team members to show attendance for.</p>
                            </div>
                        `;
                    }
                } else {
                    throw new Error('Failed to load project team members');
                }
            } catch (error) {
                console.error('Error loading team attendance:', error);
                document.getElementById('teamAttendance').innerHTML = `
                    <div class="empty-state">
                        <p>No team attendance records found for your project members.</p>
                    </div>
                `;
            }
            
            // Load pending approvals
            try {
                const approvalsResponse = await fetch('/leave-requests/pending-approval', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (approvalsResponse.ok) {
                    const approvalsData = await approvalsResponse.json();
                    displayApprovals(approvalsData, 'pendingApprovals');
                } else {
                    throw new Error('Failed to load pending approvals');
                }
            } catch (error) {
                console.error('Error loading approvals:', error);
                document.getElementById('pendingApprovals').innerHTML = `
                    <div class="empty-state">
                        <p>No pending approvals found.</p>
                    </div>
                `;
            }
            
            // Load team daily reports for project team members only
            try {
                // First get project team members
                const teamMembersResponse = await fetch('/api/development/my-project-team-members', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (teamMembersResponse.ok) {
                    const teamMembers = await teamMembersResponse.json();
                    const teamMemberIds = teamMembers.map(member => member.id);
                    
                    if (teamMemberIds.length > 0) {
                        // Get all team reports and filter
                        const reportsResponse = await fetch('/daily-reports/team', {
                            headers: { 'Authorization': `Bearer ${token}` }
                        });
                        
                        if (reportsResponse.ok) {
                            const allReportsData = await reportsResponse.json();
                            // Filter to only show reports for project team members
                            const filteredReportsData = allReportsData.filter(report => 
                                teamMemberIds.includes(report.user_id)
                            );
                            
                            // Add user names to report records
                            const reportsWithNames = filteredReportsData.map(report => {
                                const member = teamMembers.find(m => m.id === report.user_id);
                                return {
                                    ...report,
                                    user_name: member ? member.full_name : `User ${report.user_id?.substring(0, 6)}`
                                };
                            });
                            
                            displayTeamReports(reportsWithNames);
                        } else {
                            throw new Error('Failed to load team reports');
                        }
                    } else {
                        // No project team members, show empty state
                        document.getElementById('teamReports').innerHTML = `
                            <div class="empty-state">
                                <p>No project team members to show reports for.</p>
                            </div>
                        `;
                    }
                } else {
                    throw new Error('Failed to load project team members');
                }
            } catch (error) {
                console.error('Error loading team reports:', error);
                document.getElementById('teamReports').innerHTML = `
                    <div class="empty-state">
                        <p>No team reports available for your project members.</p>
                    </div>
                `;
            }
            
            // Load team lead's own daily report
            try {
                // Direct API call to get daily reports
                const reportsResponse = await fetch('/daily-reports/', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (!reportsResponse.ok) {
                    throw new Error('Failed to fetch daily reports');
                }
                
                const reports = await reportsResponse.json();
                
                // Find today's report if it exists
                const today = formatDate(new Date());
                const todayReport = reports.find(r => r.report_date === today || r.report_date === formatDate(new Date(today).setDate(new Date(today).getDate() + 1)));
                
                if (todayReport) {
                    displayDailyReport(todayReport, 'teamLeadDailyReport');
                } else {
                    document.getElementById('teamLeadDailyReport').innerHTML = `
                        <div class="empty-state">
                            <p>No daily report for today.</p>
                            <button class="btn btn-primary" id="tlCreateReportBtn">
                                <i>➕</i> Create Today's Report
                            </button>
                        </div>
                    `;
                    document.getElementById('tlCreateReportBtn').addEventListener('click', () => {
                        window.location.href = '/app/it/daily-reports?action=create';
                    });
                }
            } catch (error) {
                console.error('Error loading daily report:', error);
                document.getElementById('teamLeadDailyReport').innerHTML = `
                    <div class="empty-state">
                        <p>Error loading daily report.</p>
                        <button class="btn btn-primary" id="tlCreateReportBtn">
                            <i>➕</i> Create Today's Report
                        </button>
                    </div>
                `;
                document.getElementById('tlCreateReportBtn').addEventListener('click', () => {
                    window.location.href = '/app/it/daily-reports?action=create';
                });
            }
        }
        
        async function loadManagerDashboard() {
            const token = localStorage.getItem('bhoomitechzone_token');
            
            // Load manager's attendance first
            try {
                const todayDate = formatDate(new Date());
                const attendanceResponse = await fetch(`/attendance/history?start_date=${todayDate}&end_date=${todayDate}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (attendanceResponse.ok) {
                    const attendanceData = await attendanceResponse.json();
                    displayAttendance(attendanceData, 'managerAttendance');
                } else {
                    throw new Error('Failed to load attendance data');
                }
            } catch (error) {
                console.error('Error loading attendance:', error);
                document.getElementById('managerAttendance').innerHTML = `
                    <div class="empty-state">
                        <p>No attendance record for today.</p>
                        <button class="btn btn-primary" id="mgrCheckInBtn">
                            <i>➡️</i> Check In
                        </button>
                    </div>
                `;
                // Event listeners are now handled by global event delegation
                // No need to add individual listeners here
            }
            
            // Load department projects
            try {
                const projectsResponse = await fetch('/projects?only_managed=true', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (projectsResponse.ok) {
                    const projectsData = await projectsResponse.json();
                    displayProjects(projectsData, 'departmentProjects');
                } else {
                    throw new Error('Failed to load department projects');
                }
            } catch (error) {
                console.error('Error loading department projects:', error);
                document.getElementById('departmentProjects').innerHTML = `
                    <div class="empty-state">
                        <p>No department projects found.</p>
                    </div>
                `;
            }
            
            // Load team leaders - users with team_lead role from team members
            try {
                const teamResponse = await fetch('/api/development/team-members', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (teamResponse.ok) {
                    const teamData = await teamResponse.json();
                    // Filter to show only team leads
                    const teamLeads = teamData.filter(member => member.role === 'team_lead');
                    displayTeamLeaders(teamLeads);
                } else {
                    throw new Error('Failed to load team leaders');
                }
            } catch (error) {
                console.error('Error loading team leaders:', error);
                document.getElementById('teamLeaders').innerHTML = `
                    <div class="empty-state">
                        <p>No team leaders found.</p>
                    </div>
                `;
            }
            
            // Load pending approvals
            try {
                const approvalsResponse = await fetch('/leave-requests/pending-approval', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (approvalsResponse.ok) {
                    const approvalsData = await approvalsResponse.json();
                    displayApprovals(approvalsData, 'managerApprovals');
                } else {
                    throw new Error('Failed to load pending approvals');
                }
            } catch (error) {
                console.error('Error loading approvals:', error);
                document.getElementById('managerApprovals').innerHTML = `
                    <div class="empty-state">
                        <p>No pending approvals found.</p>
                    </div>
                `;
            }
            
            // Load department overview
            try {
                // In a real app, this would be a specific API endpoint
                // For now, we'll try to use team data to show an overview
                const teamResponse = await fetch('/api/development/team-members', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (teamResponse.ok) {
                    const teamData = await teamResponse.json();
                    displayDepartmentOverview(teamData);
                } else {
                    throw new Error('Failed to load department overview');
                }
            } catch (error) {
                console.error('Error loading department overview:', error);
                document.getElementById('departmentOverview').innerHTML = `
                    <div class="empty-state">
                        <p>No department data available.</p>
                    </div>
                `;
            }
            
            // Load manager's own daily report
            try {
                // Direct API call to get daily reports
                const reportsResponse = await fetch('/daily-reports/', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (!reportsResponse.ok) {
                    throw new Error('Failed to fetch daily reports');
                }
                
                const reports = await reportsResponse.json();
                
                // Find today's report if it exists
                const today = formatDate(new Date());
                const todayReport = reports.find(r => r.report_date === today || r.report_date === formatDate(new Date(today).setDate(new Date(today).getDate() + 1)));
                
                if (todayReport) {
                    displayDailyReport(todayReport, 'managerDailyReport');
                } else {
                    document.getElementById('managerDailyReport').innerHTML = `
                        <div class="empty-state">
                            <p>No daily report for today.</p>
                            <button class="btn btn-primary" id="mgrCreateReportBtn">
                                <i>➕</i> Create Today's Report
                            </button>
                        </div>
                    `;
                    document.getElementById('mgrCreateReportBtn').addEventListener('click', () => {
                        window.location.href = '/app/it/daily-reports?action=create';
                    });
                }
            } catch (error) {
                console.error('Error loading daily report:', error);
                document.getElementById('managerDailyReport').innerHTML = `
                    <div class="empty-state">
                        <p>Error loading daily report.</p>
                        <button class="btn btn-primary" id="mgrCreateReportBtn">
                            <i>➕</i> Create Today's Report
                        </button>
                    </div>
                `;
                document.getElementById('mgrCreateReportBtn').addEventListener('click', () => {
                    window.location.href = '/app/it/daily-reports?action=create';
                });
            }
        }
        
        async function loadDirectorDashboard() {
            const token = localStorage.getItem('bhoomitechzone_token');
            
            // Load director's attendance first
            try {
                const todayDate = formatDate(new Date());
                const attendanceResponse = await fetch(`/attendance/history?start_date=${todayDate}&end_date=${todayDate}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (attendanceResponse.ok) {
                    const attendanceData = await attendanceResponse.json();
                    displayAttendance(attendanceData, 'directorAttendance');
                } else {
                    throw new Error('Failed to load attendance data');
                }
            } catch (error) {
                console.error('Error loading attendance:', error);
                document.getElementById('directorAttendance').innerHTML = `
                    <div class="empty-state">
                        <p>No attendance record for today.</p>
                        <button class="btn btn-primary" id="dirCheckInBtn">
                            <i>➡️</i> Check In
                        </button>
                    </div>
                `;
                // Event listeners are now handled by global event delegation
                // No need to add individual listeners here
            }
            
            // Load all projects
            try {
                const projectsResponse = await fetch('/projects', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (projectsResponse.ok) {
                    const projectsData = await projectsResponse.json();
                    displayProjects(projectsData, 'allProjects');
                } else {
                    throw new Error('Failed to load projects data');
                }
            } catch (error) {
                console.error('Error loading projects:', error);
                document.getElementById('allProjects').innerHTML = `
                    <div class="empty-state">
                        <p>No projects found.</p>
                    </div>
                `;
            }
            
            // Load all users and department info
            try {
                const usersResponse = await fetch('/users/', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (usersResponse.ok) {
                    const usersData = await usersResponse.json();
                    
                    // Group users by department for department view
                    displayAllDepartments(usersData);
                    
                    // Show only managers
                    const managers = usersData.filter(u => u.role === 'manager');
                    displayManagers(managers);
                } else {
                    throw new Error('Failed to load users data');
                }
            } catch (error) {
                console.error('Error loading users:', error);
                document.getElementById('allDepartments').innerHTML = `
                    <div class="empty-state">
                        <p>No department data available.</p>
                    </div>
                `;
                document.getElementById('allManagers').innerHTML = `
                    <div class="empty-state">
                        <p>No manager data available.</p>
                    </div>
                `;
            }
            
            // Load company metrics
            try {
                // This would be a custom endpoint in a real API
                // For now, we'll just show a placeholder
                document.getElementById('companyMetrics').innerHTML = `
                    <div class="empty-state">
                        <p>Company metrics would be displayed here from the API.</p>
                    </div>
                `;
            } catch (error) {
                console.error('Error loading metrics:', error);
                document.getElementById('companyMetrics').innerHTML = `
                    <div class="empty-state">
                        <p>Error loading company metrics.</p>
                    </div>
                `;
            }
        }
        
        async function loadHRDashboard() {
            // For HR, we'll use the manager dashboard but with different data sources
            // Just load users endpoint instead of team-specific data
            const token = localStorage.getItem('bhoomitechzone_token');
            
            try {
                document.querySelector('#managerDashboard .welcome-title').textContent = 'HR Dashboard';
                document.querySelector('#managerDashboard .welcome-subtitle').textContent = 'HR activities and employee metrics';
                
                // Load HR's own attendance first
                try {
                    const todayDate = formatDate(new Date());
                    const attendanceResponse = await fetch(`/attendance/history?start_date=${todayDate}&end_date=${todayDate}`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    
                    if (attendanceResponse.ok) {
                        const attendanceData = await attendanceResponse.json();
                        displayAttendance(attendanceData, 'managerAttendance');
                    } else {
                        throw new Error('Failed to load attendance data');
                    }
                } catch (error) {
                    console.error('Error loading attendance:', error);
                    document.getElementById('managerAttendance').innerHTML = `
                        <div class="empty-state">
                            <p>No attendance record for today.</p>
                            <button class="btn btn-primary" id="hrCheckInBtn">
                                <i>➡️</i> Check In
                            </button>
                        </div>
                    `;
                    // Event listeners are now handled by global event delegation
                    // No need to add individual listeners here
                }
                
                // Load all users
                const usersResponse = await fetch('/users/', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (usersResponse.ok) {
                    const usersData = await usersResponse.json();
                    
                    // Display HR-specific views using user data
                    displayTeamLeaders(usersData.filter(u => ['manager', 'team_lead'].includes(u.role)));
                    displayDepartmentOverview(usersData);
                } else {
                    throw new Error('Failed to load users data');
                }
                
                // Load projects
                const projectsResponse = await fetch('/projects', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (projectsResponse.ok) {
                    const projectsData = await projectsResponse.json();
                    displayProjects(projectsData, 'departmentProjects');
                } else {
                    throw new Error('Failed to load projects data');
                }
                
                // Load pending leave approvals
                const approvalsResponse = await fetch('/leave-requests/pending-approval', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (approvalsResponse.ok) {
                    const approvalsData = await approvalsResponse.json();
                    displayApprovals(approvalsData, 'managerApprovals');
                } else {
                    throw new Error('Failed to load pending approvals');
                }
                
                // Load HR's own daily report
                try {
                    // Direct API call to get daily reports
                    const reportsResponse = await fetch('/daily-reports/', {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    
                    if (!reportsResponse.ok) {
                        throw new Error('Failed to fetch daily reports');
                    }
                    
                    const reports = await reportsResponse.json();
                    
                    // Find today's report if it exists
                    const today = formatDate(new Date());
                    const todayReport = reports.find(r => r.report_date === today || r.report_date === formatDate(new Date(today).setDate(new Date(today).getDate() + 1)));
                    
                    if (todayReport) {
                        displayDailyReport(todayReport, 'managerDailyReport');
                    } else {
                        document.getElementById('managerDailyReport').innerHTML = `
                            <div class="empty-state">
                                <p>No daily report for today.</p>
                                <button class="btn btn-primary" id="hrCreateReportBtn">
                                    <i>➕</i> Create Today's Report
                                </button>
                            </div>
                        `;
                        document.getElementById('hrCreateReportBtn').addEventListener('click', () => {
                            window.location.href = '/app/it/daily-reports?action=create';
                        });
                    }
                } catch (error) {
                    console.error('Error loading daily report:', error);
                    document.getElementById('managerDailyReport').innerHTML = `
                        <div class="empty-state">
                            <p>Error loading daily report.</p>
                            <button class="btn btn-primary" id="hrCreateReportBtn">
                                <i>➕</i> Create Today's Report
                            </button>
                        </div>
                    `;
                    document.getElementById('hrCreateReportBtn').addEventListener('click', () => {
                        window.location.href = '/app/it/daily-reports?action=create';
                    });
                }
                
            } catch (error) {
                console.error('Error loading HR dashboard:', error);
                showToast('Error loading HR dashboard data');
            }
        }
        
        // Display functions - all based on API data
        
        function displayEmployeeStats(stats) {
            const statsContainer = document.getElementById('employeeStats');
            statsContainer.innerHTML = '';
            
            // Projects stat
            const projectsCard = document.createElement('div');
            projectsCard.className = 'stat-card';
            projectsCard.innerHTML = `
                <div class="stat-card-header">
                    <div>
                        <div class="stat-title">Projects</div>
                        <div class="stat-value">${stats.total_projects || 0}</div>
                        <div class="stat-change">${stats.active_projects || 0} active, ${stats.completed_projects || 0} completed</div>
                    </div>
                    <div class="stat-icon blue">📁</div>
                </div>
                <div style="margin-top: 0.5rem; font-size: 0.875rem;">
                    <div style="display: flex; justify-content: space-between;">
                        <span>Active</span>
                        <span>${stats.active_projects || 0}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span>Completed</span>
                        <span>${stats.completed_projects || 0}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span>On Hold</span>
                        <span>${stats.on_hold_projects || 0}</span>
                    </div>
                </div>
            `;
            statsContainer.appendChild(projectsCard);
            
            // Tasks stat
            const tasksTotal = (stats.tasks_todo || 0) + (stats.tasks_in_progress || 0) + (stats.tasks_review || 0);
            const tasksCard = document.createElement('div');
            tasksCard.className = 'stat-card';
            tasksCard.innerHTML = `
                <div class="stat-card-header">
                    <div>
                        <div class="stat-title">Tasks</div>
                        <div class="stat-value">${tasksTotal}</div>
                        <div class="stat-change">${stats.tasks_completed || 0} completed</div>
                    </div>
                    <div class="stat-icon green">📝</div>
                </div>
                <div style="margin-top: 0.5rem; font-size: 0.875rem;">
                    <div style="display: flex; justify-content: space-between;">
                        <span>To Do</span>
                        <span>${stats.tasks_todo || 0}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span>In Progress</span>
                        <span>${stats.tasks_in_progress || 0}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span>In Review</span>
                        <span>${stats.tasks_review || 0}</span>
                    </div>
                </div>
            `;
            statsContainer.appendChild(tasksCard);
            
            // Upcoming stat
            const upcomingCard = document.createElement('div');
            upcomingCard.className = 'stat-card';
            upcomingCard.innerHTML = `
                <div class="stat-card-header">
                    <div>
                        <div class="stat-title">Upcoming</div>
                        <div class="stat-value">${stats.upcoming_tasks || 0}</div>
                        <div class="stat-change">Due in next 7 days</div>
                    </div>
                    <div class="stat-icon yellow">📅</div>
                </div>
                <div style="margin-top: 0.5rem; font-size: 0.875rem;">
                    <div style="display: flex; justify-content: space-between;">
                        <span>Overdue Tasks</span>
                        <span>${stats.overdue_tasks || 0}</span>
                    </div>
                </div>
            `;
            statsContainer.appendChild(upcomingCard);
        }
        
        function displayAttendance(data, containerId) {
            console.log('displayAttendance called with:', { data, containerId });
            
            const attendanceContainer = document.getElementById(containerId);
            if (!attendanceContainer) {
                console.error('Attendance container not found:', containerId);
                return;
            }
            
            // Clear any existing interval for this container
            if (window.attendanceIntervals && window.attendanceIntervals[containerId]) {
                clearInterval(window.attendanceIntervals[containerId]);
                delete window.attendanceIntervals[containerId];
            }
            
            // If no data found
            if (!data || data.length === 0) {
                attendanceContainer.innerHTML = `
                    <div class="empty-state">
                        <p>No attendance record for today. Check in to start your day.</p>
                        <div class="attendance-actions" style="justify-content: center;">
                            <button class="btn btn-primary" id="${containerId}CheckInBtn">
                                <i>➡️</i> Check In
                            </button>
                        </div>
                    </div>
                `;
                
                // Event listeners are now handled by global event delegation
                // No need to add individual listeners here
                return;
            }
            
            // Get today's attendance record
            const today = data[0];
            const isCheckedIn = Boolean(today.check_in);
            const isCheckedOut = Boolean(today.check_out);
            
            let workHours = '0h 0m';
            if (isCheckedIn) {
                if (isCheckedOut) {
                    workHours = formatWorkHours(new Date(today.check_in), new Date(today.check_out));
                } else {
                    workHours = formatWorkHours(new Date(today.check_in), new Date());
                }
            }
            
            // Determine status
            let status = 'Not Started';
            let statusClass = 'badge-pending';
            
            if (isCheckedIn && !isCheckedOut) {
                status = 'Working';
                statusClass = 'badge-approved';
            } else if (isCheckedIn && isCheckedOut) {
                status = 'Completed';
                statusClass = 'badge-approved';
            }
            
            attendanceContainer.innerHTML = `
                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1.5rem;">
                    <div>
                        <div style="color: var(--text-secondary); margin-bottom: 0.5rem;">Check-in time</div>
                        <div style="font-size: 1.125rem; font-weight: 500;">
                            ${isCheckedIn ? formatTime(new Date(today.check_in)) : '-- : --'}
                        </div>
                    </div>
                    <div>
                        <div style="color: var(--text-secondary); margin-bottom: 0.5rem;">Check-out time</div>
                        <div style="font-size: 1.125rem; font-weight: 500;">
                            ${isCheckedOut ? formatTime(new Date(today.check_out)) : '-- : --'}
                        </div>
                    </div>
                    <div>
                        <div style="color: var(--text-secondary); margin-bottom: 0.5rem;">Working hours</div>
                        <div style="font-size: 1.125rem; font-weight: 500;" id="${containerId}WorkHours">${workHours}</div>
                    </div>
                    <div>
                        <div style="color: var(--text-secondary); margin-bottom: 0.5rem;">Status</div>
                        <div>
                            <span class="badge ${statusClass}">${status}</span>
                        </div>
                    </div>
                </div>
                
                <div class="attendance-actions">
                    <button class="btn btn-primary ${isCheckedIn ? 'btn-disabled' : ''}" id="${containerId}CheckInBtn" ${isCheckedIn ? 'disabled' : ''}>
                        <i>➡️</i> Check In
                    </button>
                    <button class="btn btn-danger ${!isCheckedIn || isCheckedOut ? 'btn-disabled' : ''}" id="${containerId}CheckOutBtn" ${!isCheckedIn || isCheckedOut ? 'disabled' : ''}>
                        <i>⬅️</i> Check Out
                    </button>
                </div>
            `;
            
            // Event listeners are now handled by global event delegation
            // No need to add individual listeners here
            
            // Start live working hours update if user is checked in but not out
            if (isCheckedIn && !isCheckedOut) {
                if (!window.attendanceIntervals) {
                    window.attendanceIntervals = {};
                }
                
                window.attendanceIntervals[containerId] = setInterval(() => {
                    const workHoursElement = document.getElementById(`${containerId}WorkHours`);
                    if (workHoursElement && isCheckedIn && !isCheckedOut) {
                        const currentWorkHours = formatWorkHours(new Date(today.check_in), new Date());
                        workHoursElement.textContent = currentWorkHours;
                    } else {
                        // Clear interval if element no longer exists or user checked out
                        clearInterval(window.attendanceIntervals[containerId]);
                        delete window.attendanceIntervals[containerId];
                    }
                }, 1000); // Update every second
            }
            
            console.log('displayAttendance completed successfully. New UI state:', {
                isCheckedIn,
                isCheckedOut,
                status,
                workHours
            });
        }
        
        function displayTasks(projectsData) {
            const tasksContainer = document.getElementById('upcomingTasks');
            
            // Extract tasks from projects
            const allTasks = [];
            
            if (projectsData && projectsData.length > 0) {
                projectsData.forEach(project => {
                    if (project.tasks && project.tasks.length > 0) {
                        project.tasks.forEach(task => {
                            // Only include incomplete tasks
                            if (task.status !== 'completed') {
                                allTasks.push({
                                    ...task,
                                    project_name: project.name,
                                    project_id: project._id
                                });
                            }
                        });
                    }
                });
            }
            
            // If no tasks found
            if (allTasks.length === 0) {
                tasksContainer.innerHTML = `
                    <div class="empty-state">
                        <p>No upcoming tasks found.</p>
                    </div>
                `;
                return;
            }
            
            // Sort tasks by due date
            allTasks.sort((a, b) => {
                const aDate = a.due_date ? new Date(a.due_date) : new Date(9999, 0, 1);
                const bDate = b.due_date ? new Date(b.due_date) : new Date(9999, 0, 1);
                return aDate - bDate;
            });
            
            // Get up to 3 most urgent tasks
            const upcomingTasks = allTasks.slice(0, 3);
            
            tasksContainer.innerHTML = '';
            
            upcomingTasks.forEach(task => {
                // Determine priority style
                let priorityClass = 'badge-low';
                let priorityBg = 'rgba(16, 185, 129, 0.1)';
                let priorityColor = 'var(--success)';
                
                if (task.priority === 'high') {
                    priorityClass = 'badge-high';
                    priorityBg = 'rgba(239, 68, 68, 0.1)';
                    priorityColor = 'var(--danger)';
                } else if (task.priority === 'medium') {
                    priorityClass = 'badge-medium';
                    priorityBg = 'rgba(245, 158, 11, 0.1)';
                    priorityColor = 'var(--warning)';
                }
                
                // Format due date
                const dueDate = task.due_date ? 
                    `Due ${formatDateRelative(new Date(task.due_date))}` : 
                    'No due date';
                
                const taskElement = document.createElement('div');
                taskElement.className = 'list-item';
                taskElement.innerHTML = `
                    <div class="list-item-icon" style="background-color: ${priorityBg}; color: ${priorityColor};">
                        📝
                    </div>
                    <div class="list-item-content">
                        <div class="list-item-title">${task.title || 'Untitled Task'}</div>
                        <div class="list-item-subtitle">${dueDate} • ${task.project_name || 'General'}</div>
                    </div>
                    <div class="list-item-action">
                        <span class="badge ${priorityClass}">${task.priority || 'Normal'}</span>
                    </div>
                `;
                
                tasksContainer.appendChild(taskElement);
            });
        }
        
        function displayDailyReport(report, containerId) {
            const reportContainer = document.getElementById(containerId);
            
            if (!report) {
                reportContainer.innerHTML = `
                    <div class="empty-state">
                        <p>No daily report for today.</p>
                        <button class="btn btn-primary" id="${containerId}CreateBtn">
                            <i>➕</i> Create Today's Report
                        </button>
                    </div>
                `;
                
                document.getElementById(`${containerId}CreateBtn`).addEventListener('click', () => {
                    window.location.href = '/app/it/daily-reports?action=create';
                });
                return;
            }
            
            const completedTasks = report.tasks_completed ? report.tasks_completed.length : 0;
            const inProgressTasks = report.tasks_in_progress ? report.tasks_in_progress.length : 0;
            
            reportContainer.innerHTML = `
                <div class="list-item">
                    <div class="list-item-icon" style="background-color: rgba(59, 130, 246, 0.1); color: var(--primary);">
                        📋
                    </div>
                    <div class="list-item-content">
                        <div class="list-item-title">Daily Report for ${formatDate(new Date(report.report_date))}</div>
                        <div class="list-item-subtitle">
                            ${completedTasks} task${completedTasks !== 1 ? 's' : ''} completed, 
                            ${inProgressTasks} in progress
                        </div>
                        ${report.summary ? `<div style="margin-top: 0.5rem;">${report.summary}</div>` : ''}
                    </div>
                    <div class="list-item-action">
                        <a href="/app/it/daily-reports?id=${report._id}" class="card-action">View</a>
                    </div>
                </div>
                
                <div style="margin-top: 1rem;">
                    <button class="btn btn-primary" onclick="window.location.href='/app/it/daily-reports?id=${report._id}&edit=true'">
                        <i>✏️</i> Update Report
                    </button>
                </div>
            `;
        }
        
        function displayPerformance(data) {
            const performanceContainer = document.getElementById('performanceOverview');
            
            // If no data found
            if (!data || Object.keys(data).length === 0) {
                performanceContainer.innerHTML = `
                    <div class="empty-state">
                        <p>No performance data available.</p>
                    </div>
                `;
                return;
            }
            
            // Extract performance data from API response
            const lastReview = data.last_review || {};
            const lastReviewScore = lastReview.overall_rating || 'N/A';
            const scorePercentage = lastReviewScore !== 'N/A' ? (lastReviewScore / 5) * 100 : 0;
            
            // Use data from API or empty arrays if not present
            const topSkills = data.top_skills || [];
            const areasToImprove = data.improvement_areas || [];
            
            performanceContainer.innerHTML = `
                <div style="margin-bottom: 1.5rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                        <div style="font-weight: 500;">Last Review Score</div>
                        <div style="font-weight: 600; color: var(--primary);">${lastReviewScore} / 5.0</div>
                    </div>
                    <div class="progress-container">
                        <div class="progress-bar blue" style="width: ${scorePercentage}%;"></div>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div>
                        <div style="font-weight: 500; margin-bottom: 0.5rem;">Top Skills</div>
                        ${topSkills.length > 0 ? 
                            `<ul style="padding-left: 1.5rem; color: var(--text-secondary);">
                                ${topSkills.map(skill => `<li>${skill}</li>`).join('')}
                            </ul>` : 
                            '<p style="color: var(--text-secondary);">No skills data available</p>'
                        }
                    </div>
                    <div>
                        <div style="font-weight: 500; margin-bottom: 0.5rem;">Areas to Improve</div>
                        ${areasToImprove.length > 0 ? 
                            `<ul style="padding-left: 1.5rem; color: var(--text-secondary);">
                                ${areasToImprove.map(area => `<li>${area}</li>`).join('')}
                            </ul>` : 
                            '<p style="color: var(--text-secondary);">No improvement areas data available</p>'
                        }
                    </div>
                </div>
            `;
        }
        
        function displayLeaveRequests(data) {
            const leaveContainer = document.getElementById('leaveRequests');
            
            // If no data found
            if (!data || data.length === 0) {
                leaveContainer.innerHTML = `
                    <div class="empty-state">
                        <p>No leave requests found.</p>
                        <button class="btn btn-primary" id="requestLeaveBtn">
                            <i>➕</i> Request Leave
                        </button>
                    </div>
                `;
                
                document.getElementById('requestLeaveBtn').addEventListener('click', () => {
                    window.location.href = '/app/it/leave-requests';
                });
                
                return;
            }
            
            // Sort leave requests by date
            data.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
            
            // Get the most recent 2 leave requests
            const recentLeaves = data.slice(0, 2);
            
            leaveContainer.innerHTML = '';
            
            recentLeaves.forEach(leave => {
                // Format dates
                const startDate = formatDate(new Date(leave.start_date));
                const endDate = formatDate(new Date(leave.end_date));
                
                // Format status
                let statusClass = 'badge-pending';
                if (leave.status === 'approved') {
                    statusClass = 'badge-approved';
                } else if (leave.status === 'rejected') {
                    statusClass = 'badge-rejected';
                }
                
                const leaveElement = document.createElement('div');
                leaveElement.className = 'list-item';
                leaveElement.innerHTML = `
                    <div class="list-item-content">
                        <div class="list-item-title">${formatLeaveType(leave.leave_type)}</div>
                        <div class="list-item-subtitle">${startDate} - ${endDate} (${leave.duration_days} day${leave.duration_days !== 1 ? 's' : ''})</div>
                    </div>
                    <div class="list-item-action">
                        <span class="badge ${statusClass}">${capitalizeFirstLetter(leave.status)}</span>
                    </div>
                `;
                
                leaveContainer.appendChild(leaveElement);
            });
            
            // Add a button to request new leave
            const requestBtn = document.createElement('div');
            requestBtn.style.textAlign = 'center';
            requestBtn.style.marginTop = '1rem';
            requestBtn.innerHTML = `
                <button class="btn btn-primary" id="requestLeaveBtn">
                    <i>➕</i> Request New Leave
                </button>
            `;
            leaveContainer.appendChild(requestBtn);
            
            document.getElementById('requestLeaveBtn').addEventListener('click', () => {
                window.location.href = '/app/it/leave-requests';
            });
        }
        
        function displayProjects(projectsData, containerId) {
            const projectsContainer = document.getElementById(containerId);
            
            // If no data found
            if (!projectsData || projectsData.length === 0) {
                projectsContainer.innerHTML = `
                    <div class="empty-state">
                        <p>No projects found.</p>
                    </div>
                `;
                return;
            }
            
            // Sort by status (active first) and then by end date
            projectsData.sort((a, b) => {
                if (a.status === 'active' && b.status !== 'active') return -1;
                if (a.status !== 'active' && b.status === 'active') return 1;
                
                const aDate = a.end_date ? new Date(a.end_date) : new Date(9999, 0, 1);
                const bDate = b.end_date ? new Date(b.end_date) : new Date(9999, 0, 1);
                return aDate - bDate;
            });
            
            projectsContainer.innerHTML = '';
            
            // Display up to 3 projects
            const projectsToShow = projectsData.slice(0, 3);
            
            projectsToShow.forEach(project => {
                const projectElement = document.createElement('div');
                projectElement.className = 'list-item';
                
                // Calculate completion percentage based on tasks
                const totalTasks = project.tasks?.length || 0;
                const completedTasks = project.tasks?.filter(t => t.status === 'completed')?.length || 0;
                const completionPercentage = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;
                
                // Count assigned team members - either explicitly in team_members or assigned to tasks
                let assignedMembers = new Set(project.team_members || []);
                
                // Add task assignees who aren't already in team_members
                if (project.tasks && project.tasks.length > 0) {
                    project.tasks.forEach(task => {
                        if (task.assigned_to) {
                            assignedMembers.add(task.assigned_to);
                        }
                    });
                }
                
                // Determine status badge
                let statusBadge = 'badge-approved';
                let statusText = project.status === 'active' ? 'Active' : capitalizeFirstLetter(project.status || 'Unknown');
                
                projectElement.innerHTML = `
                    <div class="list-item-content">
                        <div class="list-item-title">${project.name}</div>
                        <div class="list-item-subtitle">
                            ${project.end_date ? `Due: ${formatDate(new Date(project.end_date))}` : 'No due date'} • 
                            ${totalTasks} task${totalTasks !== 1 ? 's' : ''} • 
                            ${assignedMembers.size} team member${assignedMembers.size !== 1 ? 's' : ''}
                        </div>
                        <div class="progress-container" style="margin-top: 0.5rem;">
                            <div class="progress-bar green" style="width: ${completionPercentage}%;"></div>
                        </div>
                    </div>
                    <div class="list-item-action">
                        <span class="badge ${statusBadge}">${statusText}</span>
                    </div>
                `;
                
                projectsContainer.appendChild(projectElement);
            });
        }
        
        function displayTeamMembers(teamData) {
            const teamContainer = document.getElementById('teamMembers');
            
            // If no data found
            if (!teamData || teamData.length === 0) {
                teamContainer.innerHTML = `
                    <div class="empty-state">
                        <p>No team members assigned to your active projects.</p>
                        <div style="margin-top: 1rem; font-size: 0.875rem; color: var(--text-secondary);">
                            Team members will appear here when they are assigned to projects you manage.
                        </div>
                    </div>
                `;
                return;
            }
            
            teamContainer.innerHTML = '';
            
            teamData.forEach(member => {
                const memberElement = document.createElement('div');
                memberElement.className = 'list-item';
                
                // Handle the new API response format - use full_name or construct from first/last name
                const fullName = member.full_name || 
                                `${member.first_name || ''} ${member.last_name || ''}`.trim() || 
                                member.username;
                
                // Get initials from full_name or first/last name
                const initials = member.full_name ? 
                                getInitialsFromFullName(member.full_name) :
                                getInitials(member.first_name, member.last_name);
                
                memberElement.innerHTML = `
                    <div class="list-item-icon" style="background-color: rgba(59, 130, 246, 0.1); color: var(--primary);">
                        ${initials}
                    </div>
                    <div class="list-item-content">
                        <div class="list-item-title">${fullName}</div>
                        <div class="list-item-subtitle">${member.position || member.role || 'Team Member'}</div>
                    </div>
                `;
                
                teamContainer.appendChild(memberElement);
            });
        }
        
        function displayTeamAttendance(attendanceData) {
            const attendanceContainer = document.getElementById('teamAttendance');
            
            // If no data found
            if (!attendanceData || attendanceData.length === 0) {
                attendanceContainer.innerHTML = `
                    <div class="empty-state">
                        <p>No team attendance records for today.</p>
                    </div>
                `;
                return;
            }
            
            // Group data by status
            const present = attendanceData.filter(a => a.status === 'present' && a.is_complete);
            const working = attendanceData.filter(a => a.status === 'present' && !a.is_complete);
            const absent = attendanceData.filter(a => a.status === 'absent');
            const leave = attendanceData.filter(a => a.status === 'leave');
            
            attendanceContainer.innerHTML = `
                <div style="margin-bottom: 1rem;">
                    <div style="display: flex; flex-wrap: wrap; gap: 1rem; margin-bottom: 1rem;">
                        <div style="padding: 0.5rem 1rem; background-color: var(--bg-light); border-radius: 0.5rem;">
                            <div style="color: var(--text-secondary); font-size: 0.75rem;">Present</div>
                            <div style="font-weight: 600;">${present.length + working.length}</div>
                        </div>
                        <div style="padding: 0.5rem 1rem; background-color: var(--bg-light); border-radius: 0.5rem;">
                            <div style="color: var(--text-secondary); font-size: 0.75rem;">On Leave</div>
                            <div style="font-weight: 600;">${leave.length}</div>
                        </div>
                        <div style="padding: 0.5rem 1rem; background-color: var(--bg-light); border-radius: 0.5rem;">
                            <div style="color: var(--text-secondary); font-size: 0.75rem;">Absent</div>
                            <div style="font-weight: 600;">${absent.length}</div>
                        </div>
                    </div>
                </div>
            `;
            
            // Show a few attendance records (up to 3)
            const records = [...working, ...present].slice(0, 3);
            
            if (records.length === 0) {
                attendanceContainer.innerHTML += `
                    <div class="empty-state">
                        <p>No team members are present today.</p>
                    </div>
                `;
                return;
            }
            
            records.forEach(record => {
                // In a real app, the API would include user info with attendance
                // Since our API doesn't, we'll just show user_id
                const userName = record.user_name || `User ${record.user_id?.substring(0, 6)}`;
                const checkInTime = record.check_in ? formatTime(new Date(record.check_in)) : 'Not checked in';
                
                const recordElement = document.createElement('div');
                recordElement.className = 'list-item';
                recordElement.innerHTML = `
                    <div class="list-item-content">
                        <div class="list-item-title">${userName}</div>
                        <div class="list-item-subtitle">Checked in: ${checkInTime}</div>
                    </div>
                    <div class="list-item-action">
                        <span class="badge badge-approved">Present</span>
                    </div>
                `;
                
                attendanceContainer.appendChild(recordElement);
            });
        }
        
        function displayTeamReports(reportsData) {
            const reportsContainer = document.getElementById('teamReports');
            
            // If no data found
            if (!reportsData || reportsData.length === 0) {
                reportsContainer.innerHTML = `
                    <div class="empty-state">
                        <p>No team reports found for today.</p>
                    </div>
                `;
                return;
            }
            
            reportsContainer.innerHTML = '';
            
            // Get today's reports
            const today = formatDate(new Date());
            const todayReports = reportsData.filter(r => 
                r.report_date === today || 
                r.report_date === formatDate(new Date(today).setDate(new Date(today).getDate() + 1))
            );
            
            if (todayReports.length === 0) {
                reportsContainer.innerHTML = `
                    <div class="empty-state">
                        <p>No team reports found for today.</p>
                    </div>
                `;
                return;
            }
            
            // Display up to 3 reports
            const reportsToShow = todayReports.slice(0, 3);
            
            reportsToShow.forEach(report => {
                const userName = report.user_name || `User ${report.user_id?.substring(0, 6)}`;
                const completedTasks = report.tasks_completed?.length || 0;
                const inProgressTasks = report.tasks_in_progress?.length || 0;
                
                const reportElement = document.createElement('div');
                reportElement.className = 'list-item';
                reportElement.innerHTML = `
                    <div class="list-item-content">
                        <div class="list-item-title">${userName}'s Report</div>
                        <div class="list-item-subtitle">
                            ${completedTasks} task${completedTasks !== 1 ? 's' : ''} completed, 
                            ${inProgressTasks} in progress
                        </div>
                        ${report.summary ? `<div style="margin-top: 0.5rem; font-size: 0.875rem;">${report.summary}</div>` : ''}
                    </div>
                    <div class="list-item-action">
                        <a href="/app/it/daily-reports?id=${report._id}" class="card-action">View</a>
                    </div>
                `;
                
                reportsContainer.appendChild(reportElement);
            });
        }
        
        function displayApprovals(approvalsData, containerId) {
            const approvalsContainer = document.getElementById(containerId);
            
            // If no data found
            if (!approvalsData || approvalsData.length === 0) {
                approvalsContainer.innerHTML = `
                    <div class="empty-state">
                        <p>No pending approvals found.</p>
                    </div>
                `;
                return;
            }
            
            approvalsContainer.innerHTML = '';
            
            // Show up to 3 approval requests
            const approvalsToShow = approvalsData.slice(0, 3);
            
            approvalsToShow.forEach(approval => {
                const approvalElement = document.createElement('div');
                approvalElement.className = 'list-item';
                
                // Format dates
                const startDate = formatDate(new Date(approval.start_date));
                const endDate = formatDate(new Date(approval.end_date));
                
                // In a real app, the API would include user info with the leave request
                // Since our API doesn't, we'll just show user_id
                const userName = approval.user_name || `User ${approval.user_id?.substring(0, 6)}`;
                
                approvalElement.innerHTML = `
                    <div class="list-item-content">
                        <div class="list-item-title">${userName}: ${formatLeaveType(approval.leave_type)}</div>
                        <div class="list-item-subtitle">${startDate} - ${endDate} (${approval.duration_days} day${approval.duration_days !== 1 ? 's' : ''})</div>
                    </div>
                    <div class="list-item-action">
                        <button class="btn btn-primary btn-sm" 
                            style="padding: 0.25rem 0.5rem; font-size: 0.75rem;"
                            onclick="reviewLeave('${approval._id}')">
                            Review
                        </button>
                    </div>
                `;
                
                approvalsContainer.appendChild(approvalElement);
            });
        }
        
        function displayTeamLeaders(teamLeadersData) {
            const leadersContainer = document.getElementById('teamLeaders');
            
            // If no data found
            if (!teamLeadersData || teamLeadersData.length === 0) {
                leadersContainer.innerHTML = `
                    <div class="empty-state">
                        <p>No team leaders found.</p>
                    </div>
                `;
                return;
            }
            
            leadersContainer.innerHTML = '';
            
            // Show up to 4 team leaders
            const leadersToShow = teamLeadersData.slice(0, 4);
            
            leadersToShow.forEach(leader => {
                const leaderElement = document.createElement('div');
                leaderElement.className = 'list-item';
                
                const initials = getInitials(leader.first_name, leader.last_name);
                const fullName = `${leader.first_name || ''} ${leader.last_name || ''}`.trim() || leader.username;
                
                leaderElement.innerHTML = `
                    <div class="list-item-icon" style="background-color: rgba(59, 130, 246, 0.1); color: var(--primary);">
                        ${initials}
                    </div>
                    <div class="list-item-content">
                        <div class="list-item-title">${fullName}</div>
                        <div class="list-item-subtitle">${leader.position || leader.role || 'Team Leader'}</div>
                    </div>
                `;
                
                leadersContainer.appendChild(leaderElement);
            });
        }
        
        function displayDepartmentOverview(teamData) {
            const overviewContainer = document.getElementById('departmentOverview');
            
            // If no data found
            if (!teamData || teamData.length === 0) {
                overviewContainer.innerHTML = `
                    <div class="empty-state">
                        <p>No department data available.</p>
                    </div>
                `;
                return;
            }
            
            // Group by department (if available in API)
            const departments = {};
            teamData.forEach(user => {
                const dept = user.department || 'Unassigned';
                if (!departments[dept]) {
                    departments[dept] = [];
                }
                departments[dept].push(user);
            });
            
            overviewContainer.innerHTML = `
                <div style="margin-bottom: 1rem;">
                    <div style="font-weight: 500; margin-bottom: 0.5rem;">Department Breakdown</div>
                </div>
            `;
            
            // Create department breakdown
            Object.keys(departments).forEach(dept => {
                const deptElement = document.createElement('div');
                deptElement.style.marginBottom = '1rem';
                deptElement.innerHTML = `
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                        <div>${dept}</div>
                        <div>${departments[dept].length} member${departments[dept].length !== 1 ? 's' : ''}</div>
                    </div>
                    <div class="progress-container">
                        <div class="progress-bar blue" style="width: 100%;"></div>
                    </div>
                `;
                
                overviewContainer.appendChild(deptElement);
            });
        }
        
        function displayAllDepartments(usersData) {
            const departmentsContainer = document.getElementById('allDepartments');
            
            // If no data found
            if (!usersData || usersData.length === 0) {
                departmentsContainer.innerHTML = `
                    <div class="empty-state">
                        <p>No department data available.</p>
                    </div>
                `;
                return;
            }
            
            // Group by department
            const departments = {};
            usersData.forEach(user => {
                const dept = user.department || 'Unassigned';
                if (!departments[dept]) {
                    departments[dept] = [];
                }
                departments[dept].push(user);
            });
            
            departmentsContainer.innerHTML = '';
            
            // Create department breakdown
            Object.keys(departments).forEach(dept => {
                const deptElement = document.createElement('div');
                deptElement.className = 'list-item';
                deptElement.innerHTML = `
                    <div class="list-item-content">
                        <div class="list-item-title">${dept}</div>
                        <div class="list-item-subtitle">${departments[dept].length} employee${departments[dept].length !== 1 ? 's' : ''}</div>
                        <div class="progress-container" style="margin-top: 0.5rem;">
                            <div class="progress-bar blue" style="width: 100%;"></div>
                        </div>
                    </div>
                `;
                
                departmentsContainer.appendChild(deptElement);
            });
        }
        
        function displayManagers(managersData) {
            const managersContainer = document.getElementById('allManagers');
            
            // If no data found
            if (!managersData || managersData.length === 0) {
                managersContainer.innerHTML = `
                    <div class="empty-state">
                        <p>No manager data available.</p>
                    </div>
                `;
                return;
            }
            
            managersContainer.innerHTML = '';
            
            // Display managers
            managersData.forEach(manager => {
                const managerElement = document.createElement('div');
                managerElement.className = 'list-item';
                
                const initials = getInitials(manager.first_name, manager.last_name);
                const fullName = `${manager.first_name || ''} ${manager.last_name || ''}`.trim() || manager.username;
                
                managerElement.innerHTML = `
                    <div class="list-item-icon" style="background-color: rgba(59, 130, 246, 0.1); color: var(--primary);">
                        ${initials}
                    </div>
                    <div class="list-item-content">
                        <div class="list-item-title">${fullName}</div>
                        <div class="list-item-subtitle">${manager.department || 'Department'} Manager</div>
                    </div>
                `;
                
                managersContainer.appendChild(managerElement);
            });
        }
        
        // Event handlers
        
        async function handleCheckIn() {
            console.log('handleCheckIn called');
            
            try {
                const token = localStorage.getItem('bhoomitechzone_token');
                
                // Get location (in a real app this would use geolocation)
                const location = 'Office';
                
                const isoTodayDate = new Date().toISOString().split('T')[0];
                // Get user_id from window.currentUser or localStorage
                let userId = null;
                if (window.currentUser && (window.currentUser.id || window.currentUser._id)) {
                    userId = window.currentUser.id || window.currentUser._id;
                } else {
                    userId = localStorage.getItem('user_id');
                }
                const payload = {
                    user_id: userId,
                    check_in_location: location,
                    check_in_note: 'Checked in via dashboard',
                    date: isoTodayDate
                };
                
                console.log('Sending check-in request with payload:', payload);
                
                const response = await fetch('/attendance/check-in', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                    const errorData = await response.text();
                    console.error('Check-in API error:', response.status, errorData);
                    throw new Error(`Failed to check in: ${response.status}`);
                }
                
                const responseData = await response.json();
                console.log('Check-in API response:', responseData);
                
                // Show success message immediately
                showToast('Successfully checked in');
                
                // Determine the correct container based on user role
                const role = window.userRole;
                let containerId = 'todayAttendance';
                if (role === 'team_lead') {
                    containerId = 'teamLeadAttendance';
                } else if (role === 'manager' || role === 'hr' || role === 'HR' || role === 'dev_manager') {
                    containerId = 'managerAttendance';
                } else if (role === 'director' || role === 'admin') {
                    containerId = 'directorAttendance';
                }
                
                console.log('Reloading attendance data for container:', containerId);
                
                // Reload attendance data from the history API to get the correct format
                try {
                    const todayDate = formatDate(new Date());
                    const attendanceResponse = await fetch(`/attendance/history?start_date=${todayDate}&end_date=${todayDate}`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    
                    if (attendanceResponse.ok) {
                        const attendanceData = await attendanceResponse.json();
                        console.log('Check-in: Reloaded attendance data:', attendanceData);
                        displayAttendance(attendanceData, containerId);
                        console.log('Check-in: UI updated successfully');
                    } else {
                        console.error('Failed to reload attendance data:', attendanceResponse.status);
                        throw new Error('Failed to reload attendance data');
                    }
                } catch (reloadError) {
                    console.error('Error reloading attendance data after check-in:', reloadError);
                    // Fallback: show a success message but indicate data needs refresh
                    const attendanceContainer = document.getElementById(containerId);
                    if (attendanceContainer) {
                        attendanceContainer.innerHTML = `
                            <div class="empty-state">
                                <p>✅ Check-in successful! Please refresh the page to see updated data.</p>
                                <button class="btn btn-primary" onclick="window.location.reload()">Refresh Page</button>
                            </div>
                        `;
                    }
                }
                
                // Trigger storage event to notify other tabs/pages about attendance change
                localStorage.setItem('attendance_updated', Date.now().toString());
                setTimeout(() => localStorage.removeItem('attendance_updated'), 1000);
                
                return true; // Indicate success
                
            } catch (error) {
                console.error('Error checking in:', error);
                showToast('Error checking in. Please try again.');
                
                // Reload attendance data on error to restore original state
                const role = window.userRole;
                let containerId = 'todayAttendance';
                if (role === 'team_lead') {
                    containerId = 'teamLeadAttendance';
                } else if (role === 'manager' || role === 'hr' || role === 'HR' || role == "dev_manager") {
                    containerId = 'managerAttendance';
                } else if (role === 'director' || role === 'admin') {
                    containerId = 'directorAttendance';
                }
                
                // Reload original attendance data
                try {
                    const token = localStorage.getItem('bhoomitechzone_token');
                    const todayDate = formatDate(new Date());
                    const attendanceResponse = await fetch(`/attendance/history?start_date=${todayDate}&end_date=${todayDate}`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    
                    if (attendanceResponse.ok) {
                        const attendanceData = await attendanceResponse.json();
                        displayAttendance(attendanceData, containerId);
                    }
                } catch (reloadError) {
                    console.error('Error reloading attendance data:', reloadError);
                }
                
                throw error; // Re-throw for the event handler to catch
            }
        }
        
        async function handleCheckOut() {
            console.log('handleCheckOut called');
            
            try {
                const token = localStorage.getItem('bhoomitechzone_token');
                
                // Get location (in a real app this would use geolocation)
                const location = 'Office';
                
                const isoTodayDate = new Date().toISOString().split('T')[0];
                console.log('Sending check-out request for date:', isoTodayDate);
                
                const response = await fetch('/attendance/check-out', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        check_out_location: location,
                        check_out_note: 'Checked out via dashboard',
                        work_summary: 'Completed daily tasks',
                        date: isoTodayDate
                    })
                });
                
                if (!response.ok) {
                    const errorData = await response.text();
                    console.error('Check-out API error:', response.status, errorData);
                    throw new Error(`Failed to check out: ${response.status}`);
                }
                
                const responseData = await response.json();
                console.log('Check-out API response:', responseData);
                
                // Show success message immediately
                showToast('Successfully checked out');
                
                // Determine the correct container based on user role
                const role = window.userRole;
                let containerId = 'todayAttendance';
                if (role === 'team_lead') {
                    containerId = 'teamLeadAttendance';
                } else if (role === 'manager' || role === 'hr' || role === 'HR' || role === 'dev_manager') {
                    containerId = 'managerAttendance';
                } else if (role === 'director' || role === 'admin') {
                    containerId = 'directorAttendance';
                }
                
                console.log('Reloading attendance data for container:', containerId);
                
                // Reload attendance data from the history API to get the correct format
                try {
                    const todayDate = formatDate(new Date());
                    const attendanceResponse = await fetch(`/attendance/history?start_date=${todayDate}&end_date=${todayDate}`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    
                    if (attendanceResponse.ok) {
                        const attendanceData = await attendanceResponse.json();
                        console.log('Check-out: Reloaded attendance data:', attendanceData);
                        displayAttendance(attendanceData, containerId);
                        console.log('Check-out: UI updated successfully');
                    } else {
                        console.error('Failed to reload attendance data:', attendanceResponse.status);
                        throw new Error('Failed to reload attendance data');
                    }
                } catch (reloadError) {
                    console.error('Error reloading attendance data after check-out:', reloadError);
                    // Fallback: show a success message but indicate data needs refresh
                    const attendanceContainer = document.getElementById(containerId);
                    if (attendanceContainer) {
                        attendanceContainer.innerHTML = `
                            <div class="empty-state">
                                <p>✅ Check-out successful! Please refresh the page to see updated data.</p>
                                <button class="btn btn-primary" onclick="window.location.reload()">Refresh Page</button>
                            </div>
                        `;
                    }
                }
                
                // Trigger storage event to notify other tabs/pages about attendance change
                localStorage.setItem('attendance_updated', Date.now().toString());
                setTimeout(() => localStorage.removeItem('attendance_updated'), 1000);
                
                return true; // Indicate success
                
            } catch (error) {
                console.error('Error checking out:', error);
                showToast('Error checking out. Please try again.');
                
                // Reload attendance data on error to restore original state
                const role = window.userRole;
                let containerId = 'todayAttendance';
                if (role === 'team_lead') {
                    containerId = 'teamLeadAttendance';
                } else if (role === 'manager' || role === 'hr' || role === 'HR' || role === 'dev_manager') {
                    containerId = 'managerAttendance';
                } else if (role === 'director' || role === 'admin') {
                    containerId = 'directorAttendance';
                }
                
                // Reload original attendance data
                try {
                    const token = localStorage.getItem('bhoomitechzone_token');
                    const todayDate = formatDate(new Date());
                    const attendanceResponse = await fetch(`/attendance/history?start_date=${todayDate}&end_date=${todayDate}`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    
                    if (attendanceResponse.ok) {
                        const attendanceData = await attendanceResponse.json();
                        displayAttendance(attendanceData, containerId);
                    }
                } catch (reloadError) {
                    console.error('Error reloading attendance data:', reloadError);
                }
                
                throw error; // Re-throw for the event handler to catch
            }
        }
        
        function reviewLeave(leaveId) {
            // Navigate to leave request page with the ID
            window.location.href = `/app/it/leave-requests?id=${leaveId}`;
        }
        
        function setupEventListeners() {
            // Menu toggle
            const menuToggle = document.getElementById('menuToggle');
            menuToggle.addEventListener('click', function() {
                document.querySelector('.sidebar').classList.toggle('active');
            });
            
            // User menu toggle
            const userMenu = document.getElementById('userMenu');
            const userDropdown = document.getElementById('userDropdown');
            
            userMenu.addEventListener('click', function(e) {
                e.stopPropagation();
                userDropdown.classList.toggle('active');
            });
            
            // Close user dropdown when clicking outside
            document.addEventListener('click', function() {
                userDropdown.classList.remove('active');
            });
            
            // Logout button
            document.getElementById('logoutBtn').addEventListener('click', function(e) {
                e.preventDefault();
                localStorage.removeItem('bhoomitechzone_token');
                window.location.href = '/app/login';
            });
        }
        
        // Utility functions
        
        function formatDate(date) {
            // Format date as YYYY-MM-DD
            return date.toISOString().split('T')[0];
        }
        
        function formatTime(date) {
            // Format time as HH:MM
            return date.toLocaleTimeString('en-US', {
                hour: '2-digit',
                minute: '2-digit',
                hour12: false
            });
        }
        
        function formatWorkHours(startTime, endTime) {
            // Calculate hours and minutes between two times
            const diffMs = endTime - startTime;
            const hours = Math.floor(diffMs / (1000 * 60 * 60));
            const minutes = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));
            
            return `${hours}h ${minutes}m`;
        }
        
        function formatDateRelative(date) {
            const now = new Date();  // Use current time instead of hardcoded date
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);
            
            if (date < today) {
                return 'overdue';
            } else if (date.getTime() === today.getTime()) {
                return 'today';
            } else if (date.getTime() === tomorrow.getTime()) {
                return 'tomorrow';
            } else {
                return date.toLocaleDateString('en-US', {
                    month: 'short',
                    day: 'numeric'
                });
            }
        }
        
        function formatLeaveType(leaveType) {
            if (!leaveType) return 'Leave';
            if (leaveType === 'work_from_home') return 'Work From Home';
            return leaveType.split('_').map(capitalizeFirstLetter).join(' ');
        }
        
        function capitalizeFirstLetter(string) {
            if (!string) return '';
            return string.charAt(0).toUpperCase() + string.slice(1);
        }
        
        function getInitials(firstName, lastName) {
            let initials = '';
            
            if (firstName) {
                initials += firstName.charAt(0).toUpperCase();
            }
            
            if (lastName) {
                initials += lastName.charAt(0).toUpperCase();
            }
            
            return initials || 'U';  // Default to 'U' for User
        }
        
        function getInitialsFromFullName(fullName) {
            if (!fullName) return 'U';
            
            const names = fullName.trim().split(' ');
            let initials = '';
            
            if (names.length >= 1) {
                initials += names[0].charAt(0).toUpperCase();
            }
            
            if (names.length >= 2) {
                initials += names[names.length - 1].charAt(0).toUpperCase();
            }
            
            return initials || 'U';
        }
        
        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }
        
        // Initial timestamp and username update
        document.addEventListener('DOMContentLoaded', function() {
            // This will be updated by the main getCurrentUser() function
            console.log("Dashboard loaded, waiting for user data...");
            
            // Listen for attendance updates from other tabs/pages
            window.addEventListener('storage', function(e) {
                if (e.key === 'attendance_updated') {
                    // Refresh attendance data when notified of changes
                    setTimeout(() => {
                        loadUserData();
                    }, 500);
                }
            });
        });
        
        // Cleanup function to clear intervals when page unloads
        window.addEventListener('beforeunload', function() {
            if (window.attendanceIntervals) {
                Object.values(window.attendanceIntervals).forEach(interval => {
                    clearInterval(interval);
                });
                window.attendanceIntervals = {};
            }
        });
    </script>
</body>
</html>
            